{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/middleware.ts"],"sourcesContent":["/**\n * Next.js Middleware - Runs before every request\n * \n * Handles:\n * 1. Session-based authentication for admin routes\n * 2. Legacy object storage URL rewrites\n * 3. Security headers (CSP, HSTS, X-Frame-Options, etc.)\n * 4. .replit.app domain redirect (disabled in development)\n */\n\nimport { NextResponse } from 'next/server';\nimport type { NextRequest } from 'next/server';\nimport { getIronSession } from 'iron-session';\nimport type { SessionData } from '@/lib/auth';\n\nconst sessionOptions = {\n  password: process.env.SESSION_SECRET || 'complex_password_at_least_32_characters_long_for_production',\n  cookieName: 'admin_session',\n  cookieOptions: {\n    secure: process.env.NODE_ENV === 'production',\n    httpOnly: true,\n    sameSite: 'lax' as const,\n    maxAge: 60 * 60 * 24 * 7, // 1 week\n  },\n};\n\nexport async function middleware(request: NextRequest) {\n  const { pathname } = request.nextUrl;\n\n  // Check if this is an admin route (except login page)\n  if (pathname.startsWith('/admin') && pathname !== '/admin/login') {\n    const response = NextResponse.next();\n    const session = await getIronSession<SessionData>(request.cookies, response.cookies, sessionOptions);\n\n    if (!session.isAuthenticated) {\n      // Redirect to login page\n      const loginUrl = new URL('/admin/login', request.url);\n      loginUrl.searchParams.set('from', pathname);\n      return NextResponse.redirect(loginUrl);\n    }\n  }\n\n  return handleMiddleware(request);\n}\n\nfunction handleMiddleware(request: NextRequest) {\n  const { pathname, search } = request.nextUrl;\n  const host = request.headers.get('host') || '';\n\n  // 1. Redirect .replit.app domain to custom domain (DISABLED IN DEVELOPMENT)\n  // In production, this will redirect to custom domain\n  // In development, we allow both .replit.app and localhost\n  // if (host.includes('.replit.app') && process.env.NODE_ENV === 'production') {\n  //   const customDomain = 'https://www.plumbersthatcare.com';\n  //   const redirectUrl = `${customDomain}${pathname}${search}`;\n  //   return NextResponse.redirect(redirectUrl, { status: 301 });\n  // }\n\n  // 2. Rewrite legacy object storage URLs\n  // /replit-objstore-{bucketId}/public/* â†’ /public-objects/*\n  // Preserves query strings for signed URLs and versioning\n  if (pathname.match(/^\\/replit-objstore-[^/]+\\/public\\//)) {\n    const filePathMatch = pathname.match(/^\\/replit-objstore-[^/]+\\/public\\/(.*)$/);\n    if (filePathMatch) {\n      const filePath = filePathMatch[1];\n      const url = request.nextUrl.clone();\n      url.pathname = `/public-objects/${filePath}`;\n      // Query strings (search) are automatically preserved by clone()\n      // but explicitly ensuring parity for signed URLs: url.search remains unchanged\n      return NextResponse.rewrite(url);\n    }\n  }\n\n  // 3. Set security headers on response\n  const response = NextResponse.next();\n\n  // Security headers (matching Express implementation)\n  \n  // Content Security Policy\n  const cspDirectives = [\n    \"default-src 'self'\",\n    \"script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.googletagmanager.com https://www.google-analytics.com https://connect.facebook.net https://www.clarity.ms https://c.clarity.ms https://cdn.jsdelivr.net\",\n    \"style-src 'self' 'unsafe-inline' https://fonts.googleapis.com\",\n    \"font-src 'self' https://fonts.gstatic.com data:\",\n    \"img-src 'self' data: blob: https: http:\",\n    \"connect-src 'self' https://www.google-analytics.com https://analytics.google.com https://www.facebook.com https://www.clarity.ms https://c.clarity.ms https://*.ingest.sentry.io\",\n    \"frame-src 'self' https://js.stripe.com https://hooks.stripe.com https://www.facebook.com https://servicetitan.com\",\n    \"object-src 'none'\",\n    \"base-uri 'self'\",\n    \"form-action 'self'\",\n    \"frame-ancestors 'none'\",\n    \"upgrade-insecure-requests\"\n  ];\n\n  response.headers.set('Content-Security-Policy', cspDirectives.join('; '));\n  \n  // HSTS (HTTP Strict Transport Security)\n  response.headers.set('Strict-Transport-Security', 'max-age=31536000; includeSubDomains; preload');\n  \n  // Prevent MIME type sniffing\n  response.headers.set('X-Content-Type-Options', 'nosniff');\n  \n  // Clickjacking protection\n  response.headers.set('X-Frame-Options', 'DENY');\n  \n  // Referrer policy\n  response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin');\n  \n  // Permissions policy\n  const permissionsDirectives = [\n    'geolocation=()',\n    'microphone=()',\n    'camera=()',\n    'payment=(self)',\n    'usb=()',\n    'magnetometer=()',\n    'gyroscope=()',\n    'speaker=(self)'\n  ];\n  response.headers.set('Permissions-Policy', permissionsDirectives.join(', '));\n\n  return response;\n}\n\n// Configure which routes middleware runs on\nexport const config = {\n  matcher: [\n    /*\n     * Match all request paths except:\n     * 1. /_next (Next.js internals)\n     * 2. /api/webhooks/stripe (needs raw body)\n     * 3. /api/webhooks/resend (needs raw body)\n     * 4. Static files (images, fonts, etc.)\n     */\n    '/((?!_next/static|_next/image|favicon.ico|.*\\\\.(?:svg|png|jpg|jpeg|gif|webp|woff|woff2|ttf|eot|ico)$).*)',\n  ],\n};\n"],"names":[],"mappings":"AAAA;;;;;;;;CAQC;;;;;;AAED;AAAA;AAEA;;;AAGA,MAAM,iBAAiB;IACrB,UAAU,QAAQ,GAAG,CAAC,cAAc,IAAI;IACxC,YAAY;IACZ,eAAe;QACb,QAAQ,oDAAyB;QACjC,UAAU;QACV,UAAU;QACV,QAAQ,KAAK,KAAK,KAAK;IACzB;AACF;AAEO,eAAe,WAAW,OAAoB;IACnD,MAAM,EAAE,QAAQ,EAAE,GAAG,QAAQ,OAAO;IAEpC,sDAAsD;IACtD,IAAI,SAAS,UAAU,CAAC,aAAa,aAAa,gBAAgB;QAChE,MAAM,WAAW,gMAAY,CAAC,IAAI;QAClC,MAAM,UAAU,MAAM,IAAA,0KAAc,EAAc,QAAQ,OAAO,EAAE,SAAS,OAAO,EAAE;QAErF,IAAI,CAAC,QAAQ,eAAe,EAAE;YAC5B,yBAAyB;YACzB,MAAM,WAAW,IAAI,IAAI,gBAAgB,QAAQ,GAAG;YACpD,SAAS,YAAY,CAAC,GAAG,CAAC,QAAQ;YAClC,OAAO,gMAAY,CAAC,QAAQ,CAAC;QAC/B;IACF;IAEA,OAAO,iBAAiB;AAC1B;AAEA,SAAS,iBAAiB,OAAoB;IAC5C,MAAM,EAAE,QAAQ,EAAE,MAAM,EAAE,GAAG,QAAQ,OAAO;IAC5C,MAAM,OAAO,QAAQ,OAAO,CAAC,GAAG,CAAC,WAAW;IAE5C,4EAA4E;IAC5E,qDAAqD;IACrD,0DAA0D;IAC1D,+EAA+E;IAC/E,6DAA6D;IAC7D,+DAA+D;IAC/D,gEAAgE;IAChE,IAAI;IAEJ,wCAAwC;IACxC,2DAA2D;IAC3D,yDAAyD;IACzD,IAAI,SAAS,KAAK,CAAC,uCAAuC;QACxD,MAAM,gBAAgB,SAAS,KAAK,CAAC;QACrC,IAAI,eAAe;YACjB,MAAM,WAAW,aAAa,CAAC,EAAE;YACjC,MAAM,MAAM,QAAQ,OAAO,CAAC,KAAK;YACjC,IAAI,QAAQ,GAAG,CAAC,gBAAgB,EAAE,UAAU;YAC5C,gEAAgE;YAChE,+EAA+E;YAC/E,OAAO,gMAAY,CAAC,OAAO,CAAC;QAC9B;IACF;IAEA,sCAAsC;IACtC,MAAM,WAAW,gMAAY,CAAC,IAAI;IAElC,qDAAqD;IAErD,0BAA0B;IAC1B,MAAM,gBAAgB;QACpB;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACD;IAED,SAAS,OAAO,CAAC,GAAG,CAAC,2BAA2B,cAAc,IAAI,CAAC;IAEnE,wCAAwC;IACxC,SAAS,OAAO,CAAC,GAAG,CAAC,6BAA6B;IAElD,6BAA6B;IAC7B,SAAS,OAAO,CAAC,GAAG,CAAC,0BAA0B;IAE/C,0BAA0B;IAC1B,SAAS,OAAO,CAAC,GAAG,CAAC,mBAAmB;IAExC,kBAAkB;IAClB,SAAS,OAAO,CAAC,GAAG,CAAC,mBAAmB;IAExC,qBAAqB;IACrB,MAAM,wBAAwB;QAC5B;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACD;IACD,SAAS,OAAO,CAAC,GAAG,CAAC,sBAAsB,sBAAsB,IAAI,CAAC;IAEtE,OAAO;AACT;AAGO,MAAM,SAAS;IACpB,SAAS;QACP;;;;;;KAMC,GACD;KACD;AACH"}}]
}