{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/server/lib/serviceTitanSync.ts"],"sourcesContent":["import { getServiceTitanAPI } from \"./serviceTitan\";\n\n// Mutex to prevent concurrent syncs\nlet syncInProgress = false;\nlet lastSyncHeartbeat = Date.now();\n\n/**\n * Check if a ServiceTitan sync is currently running\n */\nexport function isSyncRunning(): boolean {\n  // If sync has been \"running\" for more than 30 minutes without heartbeat, consider it stale\n  if (syncInProgress && Date.now() - lastSyncHeartbeat > 30 * 60 * 1000) {\n    console.log('[ServiceTitan Sync] ‚ö†Ô∏è  Detected stale sync lock (no heartbeat for 30min), resetting...');\n    syncInProgress = false;\n  }\n  return syncInProgress;\n}\n\n/**\n * Reset the sync mutex (admin tool only)\n */\nexport function resetSyncLock(): void {\n  console.log('[ServiceTitan Sync] üîì Manually resetting sync lock...');\n  syncInProgress = false;\n  lastSyncHeartbeat = Date.now();\n}\n\n/**\n * Update heartbeat to prevent stale lock detection\n */\nexport function updateSyncHeartbeat(): void {\n  lastSyncHeartbeat = Date.now();\n}\n\n/**\n * Sync all customers from ServiceTitan to local database\n * Protected by mutex to prevent concurrent execution\n */\nexport async function syncServiceTitanCustomers(): Promise<void> {\n  // Check if sync is already running\n  if (syncInProgress) {\n    console.log('[ServiceTitan Sync] ‚è≠Ô∏è  Sync already in progress, skipping...');\n    return;\n  }\n\n  try {\n    syncInProgress = true;\n    console.log('[ServiceTitan Sync] Starting customer sync...');\n    \n    const serviceTitan = getServiceTitanAPI();\n    const result = await serviceTitan.syncAllCustomers();\n    \n    console.log(`[ServiceTitan Sync] ‚úÖ Customer sync completed!`);\n    console.log(`[ServiceTitan Sync] - Customers synced: ${result.customersCount}`);\n    console.log(`[ServiceTitan Sync] - Contacts synced: ${result.contactsCount}`);\n    console.log(`[ServiceTitan Sync] - Duration: ${(result.duration / 1000).toFixed(1)}s`);\n  } catch (error) {\n    console.error('[ServiceTitan Sync] ‚ùå Customer sync failed:', error);\n  } finally {\n    syncInProgress = false;\n  }\n}\n\n/**\n * Sync all data from ServiceTitan to local database (customers + jobs)\n * Protected by mutex to prevent concurrent execution\n */\nexport async function syncServiceTitanData(): Promise<void> {\n  // Check if sync is already running\n  if (syncInProgress) {\n    console.log('[ServiceTitan Sync] ‚è≠Ô∏è  Sync already in progress, skipping...');\n    return;\n  }\n\n  try {\n    syncInProgress = true;\n    const startTime = Date.now();\n    console.log('[ServiceTitan Sync] üöÄ Starting full data sync (customers + jobs)...');\n    \n    const serviceTitan = getServiceTitanAPI();\n    \n    // Sync customers first\n    console.log('[ServiceTitan Sync] üìã Phase 1/2: Syncing customers...');\n    updateSyncHeartbeat();\n    const customerResult = await serviceTitan.syncAllCustomers();\n    \n    console.log(`[ServiceTitan Sync] ‚úÖ Customer sync completed!`);\n    console.log(`[ServiceTitan Sync] - Customers synced: ${customerResult.customersCount}`);\n    console.log(`[ServiceTitan Sync] - Contacts synced: ${customerResult.contactsCount}`);\n    console.log(`[ServiceTitan Sync] - Customer sync duration: ${(customerResult.duration / 1000).toFixed(1)}s`);\n    \n    // Sync jobs\n    console.log('[ServiceTitan Sync] üìã Phase 2/2: Syncing jobs...');\n    updateSyncHeartbeat();\n    const jobResult = await serviceTitan.syncAllJobs();\n    \n    console.log(`[ServiceTitan Sync] ‚úÖ Job sync completed!`);\n    console.log(`[ServiceTitan Sync] - Jobs synced: ${jobResult.jobsCount}`);\n    console.log(`[ServiceTitan Sync] - Customers updated: ${jobResult.customersUpdated}`);\n    console.log(`[ServiceTitan Sync] - Job sync duration: ${(jobResult.duration / 1000).toFixed(1)}s`);\n    \n    const totalDuration = (Date.now() - startTime) / 1000;\n    console.log(`[ServiceTitan Sync] ‚ú® Full data sync completed in ${totalDuration.toFixed(1)}s`);\n  } catch (error) {\n    console.error('[ServiceTitan Sync] ‚ùå Data sync failed:', error);\n  } finally {\n    syncInProgress = false;\n  }\n}\n\n/**\n * Start the ServiceTitan data sync scheduler\n * - Full sync every 6 hours (for complete data integrity)\n * - Runs initial sync on startup\n * - Syncs both customers and jobs\n */\nexport async function startServiceTitanSync(): Promise<void> {\n  console.log('[ServiceTitan Sync] Scheduler started - will sync customers and jobs every 6 hours');\n  \n  // Run initial full sync on startup\n  try {\n    const { customersXlsx, serviceTitanJobs } = await import('@shared/schema');\n    const { db } = await import('../db');\n    const { count } = await import('drizzle-orm');\n    \n    const customerResult = await db.select({ count: count() }).from(customersXlsx);\n    const customerCount = customerResult[0]?.count || 0;\n    \n    const jobResult = await db.select({ count: count() }).from(serviceTitanJobs);\n    const jobCount = jobResult[0]?.count || 0;\n    \n    console.log(`[ServiceTitan Sync] üöÄ Starting full data sync...`);\n    console.log(`[ServiceTitan Sync] üìä Current cache: ${customerCount} customers, ${jobCount} jobs`);\n    \n    // Run sync without blocking startup\n    syncServiceTitanData().catch(error => {\n      console.error('[ServiceTitan Sync] Initial sync failed:', error);\n    });\n  } catch (error) {\n    console.error('[ServiceTitan Sync] Failed to check data counts:', error);\n  }\n  \n  // Run full sync every 6 hours to keep cache fresh\n  setInterval(() => {\n    console.log('[ServiceTitan Sync] üîÑ Starting scheduled 6-hour data sync...');\n    syncServiceTitanData().catch(error => {\n      console.error('[ServiceTitan Sync] Scheduled sync failed:', error);\n    });\n  }, 6 * 60 * 60 * 1000); // 6 hours\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}