{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/src/lib/session.ts"],"sourcesContent":["/**\n * Session Management for Next.js App Router\n * \n * Replaces express-session with iron-session for Next.js compatibility\n * Preserves all existing OAuth functionality\n */\n\nimport { getIronSession, type IronSession } from 'iron-session';\nimport { cookies } from 'next/headers';\n\nexport interface SessionData {\n  user?: {\n    id: string;\n    email: string;\n    firstName?: string;\n    lastName?: string;\n    profileImageUrl?: string;\n    claims?: any;\n    access_token?: string;\n    refresh_token?: string;\n    expires_at?: number;\n  };\n  isAdmin?: boolean;\n  oauthState?: string;\n  oauthCodeVerifier?: string;\n  customerPortalAuth?: {\n    customerId: number;\n    email: string;\n    phone: string;\n    verifiedAt: number;\n  };\n}\n\nif (!process.env.SESSION_SECRET) {\n  throw new Error('SESSION_SECRET environment variable is required');\n}\n\nconst sessionOptions = {\n  password: process.env.SESSION_SECRET,\n  cookieName: 'plumbing_session',\n  ttl: 7 * 24 * 60 * 60, // 1 week (in seconds)\n  cookieOptions: {\n    httpOnly: true,\n    secure: process.env.NODE_ENV === 'production',\n    sameSite: 'lax' as const,\n    maxAge: 7 * 24 * 60 * 60, // 1 week (in seconds)\n    path: '/',\n  },\n};\n\n/**\n * Get the current session from cookies\n */\nexport async function getSession(): Promise<IronSession<SessionData>> {\n  const cookieStore = await cookies();\n  return getIronSession<SessionData>(cookieStore, sessionOptions);\n}\n\n/**\n * Check if user is authenticated\n */\nexport async function isAuthenticated(): Promise<boolean> {\n  const session = await getSession();\n  return !!session.user && !!session.user.expires_at && session.user.expires_at > Math.floor(Date.now() / 1000);\n}\n\n/**\n * Check if user is admin\n */\nexport async function isAdmin(): Promise<boolean> {\n  const session = await getSession();\n  return !!session.isAdmin && await isAuthenticated();\n}\n\n/**\n * Get current user from session\n */\nexport async function getCurrentUser() {\n  const session = await getSession();\n  return session.user;\n}\n\n/**\n * Destroy session (logout)\n */\nexport async function destroySession() {\n  const session = await getSession();\n  session.destroy();\n}\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;;;;;;;;;AAED;AACA;;;AAyBA,IAAI,CAAC,QAAQ,GAAG,CAAC,cAAc,EAAE;IAC/B,MAAM,IAAI,MAAM;AAClB;AAEA,MAAM,iBAAiB;IACrB,UAAU,QAAQ,GAAG,CAAC,cAAc;IACpC,YAAY;IACZ,KAAK,IAAI,KAAK,KAAK;IACnB,eAAe;QACb,UAAU;QACV,QAAQ,oDAAyB;QACjC,UAAU;QACV,QAAQ,IAAI,KAAK,KAAK;QACtB,MAAM;IACR;AACF;AAKO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,4IAAO;IACjC,OAAO,IAAA,oKAAc,EAAc,aAAa;AAClD;AAKO,eAAe;IACpB,MAAM,UAAU,MAAM;IACtB,OAAO,CAAC,CAAC,QAAQ,IAAI,IAAI,CAAC,CAAC,QAAQ,IAAI,CAAC,UAAU,IAAI,QAAQ,IAAI,CAAC,UAAU,GAAG,KAAK,KAAK,CAAC,KAAK,GAAG,KAAK;AAC1G;AAKO,eAAe;IACpB,MAAM,UAAU,MAAM;IACtB,OAAO,CAAC,CAAC,QAAQ,OAAO,IAAI,MAAM;AACpC;AAKO,eAAe;IACpB,MAAM,UAAU,MAAM;IACtB,OAAO,QAAQ,IAAI;AACrB;AAKO,eAAe;IACpB,MAAM,UAAU,MAAM;IACtB,QAAQ,OAAO;AACjB","debugId":null}},
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/servicetitan/auth/route.ts"],"sourcesContent":["/**\n * ServiceTitan OAuth - Initiate Authentication\n * \n * Starts OAuth flow for customer portal login\n */\n\nimport { NextRequest, NextResponse } from 'next/server';\nimport { randomBytes } from 'crypto';\nimport { getSession } from '@/lib/session';\n\nexport async function GET(req: NextRequest) {\n  try {\n    const hostname = req.headers.get('host') || '';\n    \n    // Generate state for CSRF protection\n    const state = randomBytes(32).toString('hex');\n    \n    // Store state in session\n    const session = await getSession();\n    session.serviceTitanOAuthState = state;\n    await session.save();\n\n    // Build ServiceTitan OAuth URL\n    const authUrl = new URL('https://auth.servicetitan.io/connect/authorize');\n    authUrl.searchParams.set('client_id', process.env.SERVICETITAN_CLIENT_ID || '');\n    authUrl.searchParams.set('response_type', 'code');\n    authUrl.searchParams.set('redirect_uri', `https://${hostname}/api/servicetitan/callback`);\n    authUrl.searchParams.set('scope', 'openid profile email offline_access');\n    authUrl.searchParams.set('state', state);\n\n    return NextResponse.redirect(authUrl.toString());\n  } catch (error) {\n    console.error('[ServiceTitan OAuth] Error:', error);\n    return NextResponse.redirect('/customer-portal/login?error=auth_failed');\n  }\n}\n"],"names":[],"mappings":"AAAA;;;;CAIC;;;;AAED;AACA;AACA;;;;AAEO,eAAe,IAAI,GAAgB;IACxC,IAAI;QACF,MAAM,WAAW,IAAI,OAAO,CAAC,GAAG,CAAC,WAAW;QAE5C,qCAAqC;QACrC,MAAM,QAAQ,IAAA,oHAAW,EAAC,IAAI,QAAQ,CAAC;QAEvC,yBAAyB;QACzB,MAAM,UAAU,MAAM,IAAA,qIAAU;QAChC,QAAQ,sBAAsB,GAAG;QACjC,MAAM,QAAQ,IAAI;QAElB,+BAA+B;QAC/B,MAAM,UAAU,IAAI,IAAI;QACxB,QAAQ,YAAY,CAAC,GAAG,CAAC,aAAa,QAAQ,GAAG,CAAC,sBAAsB,IAAI;QAC5E,QAAQ,YAAY,CAAC,GAAG,CAAC,iBAAiB;QAC1C,QAAQ,YAAY,CAAC,GAAG,CAAC,gBAAgB,CAAC,QAAQ,EAAE,SAAS,0BAA0B,CAAC;QACxF,QAAQ,YAAY,CAAC,GAAG,CAAC,SAAS;QAClC,QAAQ,YAAY,CAAC,GAAG,CAAC,SAAS;QAElC,OAAO,gJAAY,CAAC,QAAQ,CAAC,QAAQ,QAAQ;IAC/C,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,+BAA+B;QAC7C,OAAO,gJAAY,CAAC,QAAQ,CAAC;IAC/B;AACF","debugId":null}}]
}