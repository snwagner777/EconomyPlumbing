module.exports=[292309,e=>{"use strict";var t=e.i(457420);class r{config;baseUrl;accessToken=null;tokenExpiry=0;constructor(e){this.config=e,this.baseUrl=`https://api.servicetitan.io/crm/v2/tenant/${e.tenantId}`}async authenticate(){if(this.accessToken&&Date.now()<this.tokenExpiry)return;let e=Buffer.from(`${this.config.clientId}:${this.config.clientSecret}`).toString("base64");try{let t=await fetch("https://auth.servicetitan.io/connect/token",{method:"POST",headers:{Authorization:`Basic ${e}`,"Content-Type":"application/x-www-form-urlencoded"},body:"grant_type=client_credentials"});if(!t.ok)throw Error(`Authentication failed: ${t.statusText}`);let r=await t.json();this.accessToken=r.access_token,this.tokenExpiry=Date.now()+1e3*r.expires_in-6e4}catch(e){throw console.error("[ServiceTitan] Authentication error:",e),e}}async request(e,t={},r=!1){await this.authenticate();let o=r?e:`${this.baseUrl}${e}`,a={Authorization:`Bearer ${this.accessToken}`,"ST-App-Key":this.config.appKey,"Content-Type":"application/json",...t.headers};console.log("[ServiceTitan] API Request:",{url:o,method:t.method||"GET",hasToken:!!this.accessToken,hasAppKey:!!this.config.appKey});try{let e=await fetch(o,{...t,headers:a});if(console.log("[ServiceTitan] API Response:",{status:e.status,statusText:e.statusText,ok:e.ok}),!e.ok){let t=await e.text();throw console.error("[ServiceTitan] API Error Response:",t),Error(`ServiceTitan API error: ${e.status} - ${t}`)}let r=await e.text();if(!r||""===r.trim())return console.log("[ServiceTitan] Empty response body"),{};console.log("[ServiceTitan] Raw response text (first 1000 chars):",r.substring(0,1e3));try{let e=JSON.parse(r);return console.log("[ServiceTitan] Parsed JSON keys:",Object.keys(e)),console.log("[ServiceTitan] Has data property:","data"in e),console.log("[ServiceTitan] Data length:",Array.isArray(e?.data)?e.data.length:"not an array"),e}catch(e){throw console.error("[ServiceTitan] JSON parse error:",e),console.error("[ServiceTitan] Response text was:",r),Error(`Failed to parse ServiceTitan response: ${e}`)}}catch(e){throw console.error("[ServiceTitan] API request error:",e),e}}normalizePhone(e){let t=e.replace(/\D/g,"");return 11===t.length&&t.startsWith("1")?t.substring(1):t}async searchAllCustomersLive(e){try{let t=e.includes("@");if(console.log(`[ServiceTitan] Live API search for ALL customers with ${t?"email":"phone"}: "${e}"`),t){let t=await this.request(`/customers?email=${encodeURIComponent(e.trim())}`);if(t.data&&t.data.length>0)return console.log(`[ServiceTitan] Found ${t.data.length} customer(s) with email ${e}`),t.data}else{let t=this.normalizePhone(e);console.log(`[ServiceTitan] Searching for phone: ${t}`);try{let r=`https://api.servicetitan.io/crm/v2/tenant/${this.config.tenantId}/contacts/search`,o=await this.request(r,{method:"POST",body:JSON.stringify({value:t,page:1,pageSize:50})},!0);if(o.data&&o.data.length>0){let t=Array.from(new Set(o.data.map(e=>e.customerId)));console.log(`[ServiceTitan] Found ${t.length} customer(s) with phone ${e}`);let r=[];for(let e of t)try{let t=await this.request(`/customers/${e}`);r.push(t)}catch(t){console.error(`[ServiceTitan] Failed to fetch customer ${e}:`,t)}return r}}catch(e){console.error("[ServiceTitan] Contacts search error:",e)}}return console.log("[ServiceTitan] No customers found via live API"),[]}catch(e){return console.error("[ServiceTitan] Live API search error:",e),[]}}async searchCustomer(e,t){try{console.log(`[ServiceTitan] Searching for customer - email: "${e}", phone: "${t}"`);let r=null;if(e&&e.trim()){console.log("[ServiceTitan] Strategy 1: Searching by email...");try{let t=await this.request(`/customers?email=${encodeURIComponent(e.trim())}`);if(t.data&&t.data.length>0)return console.log(`[ServiceTitan] Found customer by email: ${t.data[0].id}`),t.data[0];console.log("[ServiceTitan] No customer found by email")}catch(e){console.error("[ServiceTitan] Email search error:",e.message)}}if(!r&&t&&t.trim()){console.log("[ServiceTitan] Strategy 2: Trying Contacts Search API for phone...");let e=this.normalizePhone(t);console.log(`[ServiceTitan] Normalized phone: "${e}"`);try{let t=`https://api.servicetitan.io/crm/v2/tenant/${this.config.tenantId}/contacts/search`,o=await this.request(t,{method:"POST",body:JSON.stringify({value:e,page:1,pageSize:10})},!0);o.data&&o.data.length>0&&(r=o.data[0].customerId,console.log(`[ServiceTitan] Contacts Search found customerId: ${r}`))}catch(e){console.log("[ServiceTitan] Contacts Search API not available, trying alternative methods...")}}if(!r&&t&&t.trim()){console.log("[ServiceTitan] Strategy 3: Fast pagination search (250 customers max)...");let e=this.normalizePhone(t);for(let t=1;t<=5;t++){console.log(`[ServiceTitan] Checking page ${t}/5...`);let r=await this.request(`/customers?page=${t}&pageSize=50`);if(!r.data||0===r.data.length)break;for(let t=0;t<r.data.length;t+=10){let o=r.data.slice(t,t+10);for(let t of(await Promise.allSettled(o.map(async t=>{try{for(let r of(await this.getCustomerContacts(t.id))){let o=r.value||r.phoneSettings?.phoneNumber;if(o&&("Phone"===r.type||"MobilePhone"===r.type)&&this.normalizePhone(o)===e)return console.log(`[ServiceTitan] MATCH FOUND! Customer ${t.id} (${t.name})`),t}return null}catch(e){return null}}))))if("fulfilled"===t.status&&t.value)return t.value}if(!1===r.hasMore||r.data.length<50)break}console.log("[ServiceTitan] No match found in first 250 customers")}if(r)return console.log(`[ServiceTitan] Fetching customer details for ID: ${r}`),await this.request(`/customers/${r}`);return console.log("[ServiceTitan] Customer not found by any method"),null}catch(e){throw console.error("[ServiceTitan] Search customer error:",e.message||e),e}}async createCustomer(e){let t={street:e.street,city:e.city,state:e.state,zip:e.zip,country:"USA"},r=[{type:"Phone",value:e.phone,isPrimary:!0},{type:"Email",value:e.email,isPrimary:!0}],o=[{type:"Phone",value:e.phone,isPrimary:!0},{type:"Email",value:e.email,isPrimary:!0}],a="residential"===e.type?{request:{type:"Residential",name:e.name,contacts:r,locations:[{name:"Primary Residence",address:t,contacts:o}]}}:{request:{type:"Commercial",companyName:e.companyName,contacts:r,locations:[{name:e.companyName||"Primary Location",address:t,contacts:o}]}};try{return(await this.request("/customers",{method:"POST",body:JSON.stringify(a)})).data}catch(e){throw console.error("[ServiceTitan] Create customer error:",e),e}}async createMembershipInvoice(e,t,r){try{return(await this.request("/accounting/v2/invoices",{method:"POST",body:JSON.stringify({customerId:e,items:[{skuId:t,quantity:1,price:r}]})})).data}catch(e){throw console.error("[ServiceTitan] Create membership invoice error:",e),e}}async markInvoicePaid(e,t,r="Credit Card"){try{await this.request(`/invoices/${e}/payments`,{method:"POST",body:JSON.stringify({amount:t,paymentMethod:r,status:"Paid"})})}catch(e){throw console.error("[ServiceTitan] Mark invoice paid error:",e),e}}async processMembershipPurchase(e){try{if(!e.serviceTitanMembershipTypeId)throw Error("ServiceTitan membership type ID is required but missing. Please configure the product with a valid ServiceTitan membership type ID.");let t=parseInt(e.serviceTitanMembershipTypeId);if(isNaN(t))throw Error(`Invalid ServiceTitan membership type ID: "${e.serviceTitanMembershipTypeId}". Must be a numeric ID.`);let r=await this.searchCustomer(e.email,e.phone);r?console.log(`[ServiceTitan] Found existing customer with ID: ${r.id}`):(console.log("[ServiceTitan] Customer not found, creating new customer..."),r=await this.createCustomer({type:e.customerType,name:e.customerName||void 0,companyName:e.companyName||void 0,contactName:e.contactPersonName||void 0,email:e.email,phone:e.phone,street:e.street,city:e.city,state:e.state,zip:e.zip}),console.log(`[ServiceTitan] Created customer with ID: ${r.id}`)),console.log("[ServiceTitan] Creating membership invoice...");let o=await this.createMembershipInvoice(r.id,t,e.amount/100);return console.log(`[ServiceTitan] Created invoice with ID: ${o.id}`),console.log("[ServiceTitan] Marking invoice as paid..."),await this.markInvoicePaid(o.id,e.amount/100),console.log("[ServiceTitan] Invoice marked as paid"),{customerId:r.id,membershipId:o.id,invoiceId:o.id}}catch(e){throw console.error("[ServiceTitan] Process membership purchase error:",e),e}}async getCustomerContacts(e){try{return(await this.request(`/customers/${e}/contacts`)).data||[]}catch(e){return console.error("[ServiceTitan] Get customer contacts error:",e),[]}}async getCustomer(e){try{let t=await this.request(`/customers/${e}`),r=await this.getCustomerContacts(e),o=r.find(e=>"Email"===e.type),a=r.find(e=>"Phone"===e.type||"MobilePhone"===e.type)||r.find(e=>e.phoneSettings);console.log(`[Portal Debug] Customer ${e} - Found ${r.length} contacts`),console.log("[Portal Debug] Email contact:",o?.value||"NONE"),console.log("[Portal Debug] Phone contact:",a?.value||a?.phoneSettings?.phoneNumber||"NONE"),console.log("[Portal Debug] Customer record email:",t.email||"NONE"),console.log("[Portal Debug] Customer record phoneNumber:",t.phoneNumber||"NONE");let i={...t,email:o?.value||t.email||"",phoneNumber:a?.value||a?.phoneSettings?.phoneNumber||t.phoneNumber||"",contacts:r.map(e=>({id:e.id,type:e.type,value:e.value||e.phoneSettings?.phoneNumber||"",memo:e.memo,phoneSettings:e.phoneSettings}))};return console.log("[Portal Debug] Final email field:",i.email||"EMPTY STRING"),console.log("[Portal Debug] Final phoneNumber field:",i.phoneNumber||"EMPTY STRING"),console.log(`[Portal Debug] Returning ${i.contacts.length} contacts`),i}catch(e){throw console.error("[ServiceTitan] Get customer error:",e),e}}async updateCustomerContacts(e,t){try{console.log(`[ServiceTitan] Updating customer ${e} contacts...`);let r=await this.getCustomerContacts(e);if(t.email){let o=r.find(e=>"Email"===e.type);o?await this.request(`/customers/${e}/contacts/${o.id}`,{method:"PUT",body:JSON.stringify({type:"Email",value:t.email,memo:"email"})}):await this.request(`/customers/${e}/contacts`,{method:"POST",body:JSON.stringify({type:"Email",value:t.email,memo:"email"})})}if(t.phone){let o=r.find(e=>"Phone"===e.type||"MobilePhone"===e.type);o?await this.request(`/customers/${e}/contacts/${o.id}`,{method:"PUT",body:JSON.stringify({type:o.type,value:t.phone,memo:o.memo||"Phone",phoneSettings:{phoneNumber:t.phone,doNotText:o.phoneSettings?.doNotText||!1}})}):await this.request(`/customers/${e}/contacts`,{method:"POST",body:JSON.stringify({type:"Phone",value:t.phone,memo:"Phone",phoneSettings:{phoneNumber:t.phone,doNotText:!1}})})}console.log("[ServiceTitan] Customer contacts updated successfully")}catch(e){throw console.error("[ServiceTitan] Update customer contacts error:",e),e}}async deleteCustomerContact(e,t){try{console.log(`[ServiceTitan] Deleting contact ${t} for customer ${e}...`),await this.request(`/customers/${e}/contacts/${t}`,{method:"DELETE"}),console.log("[ServiceTitan] Contact deleted successfully")}catch(e){throw console.error("[ServiceTitan] Delete contact error:",e),e}}async updateLocation(e,t){try{console.log(`[ServiceTitan] Updating location ${e}...`);let r={street:t.street,city:t.city,state:t.state,zip:t.zip,country:"USA"};await this.request(`/locations/${e}`,{method:"PUT",body:JSON.stringify({address:r})}),console.log("[ServiceTitan] Location updated successfully")}catch(e){throw console.error("[ServiceTitan] Update location error:",e),e}}async getCustomerPrimaryLocation(e){try{let t=`https://api.servicetitan.io/crm/v2/tenant/${this.config.tenantId}/locations?customerId=${e}`,r=await this.request(t,{},!0);return r.data&&r.data.length>0?r.data[0]:null}catch(e){throw console.error("[ServiceTitan] Get customer primary location error:",e),e}}async getAllCustomerLocations(e){try{let t=`https://api.servicetitan.io/crm/v2/tenant/${this.config.tenantId}/locations?customerId=${e}`,r=await this.request(t,{},!0);return console.log(`[ServiceTitan] Found ${r.data?.length||0} locations for customer ${e}`),r.data||[]}catch(e){throw console.error("[ServiceTitan] Get all customer locations error:",e),e}}async getArrivalWindows(){try{let e=`https://api.servicetitan.io/jpm/v2/tenant/${this.config.tenantId}/appointments?pageSize=100`,t=(await this.request(e,{},!0)).data||[],r=new Map;return t.forEach(e=>{if(e.arrivalWindowStart&&e.arrivalWindowEnd){let t=new Date(e.arrivalWindowStart),o=new Date(e.arrivalWindowEnd),a=`${t.getUTCHours().toString().padStart(2,"0")}:${t.getUTCMinutes().toString().padStart(2,"0")}`,i=`${o.getUTCHours().toString().padStart(2,"0")}:${o.getUTCMinutes().toString().padStart(2,"0")}`,n=`${a}-${i}`;r.has(n)||r.set(n,{start:a,end:i})}}),Array.from(r.values()).sort((e,t)=>e.start.localeCompare(t.start)).map(e=>{let t=e=>{let[t,r]=e.split(":").map(Number);return`${0===t?12:t>12?t-12:t}:${r.toString().padStart(2,"0")} ${t>=12?"PM":"AM"}`};return{start:e.start,end:e.end,label:`${t(e.start)} - ${t(e.end)}`}})}catch(e){return console.error("[ServiceTitan] Get arrival windows error:",e),[{start:"08:00",end:"12:00",label:"8:00 AM - 12:00 PM"},{start:"12:00",end:"16:00",label:"12:00 PM - 4:00 PM"},{start:"16:00",end:"20:00",label:"4:00 PM - 8:00 PM"}]}}async rescheduleAppointment(e,t,r){try{let o=`https://api.servicetitan.io/jpm/v2/tenant/${this.config.tenantId}/appointments/${e}`;console.log(`[ServiceTitan] Rescheduling appointment ${e} to ${t}`);let a=await this.request(o,{method:"PUT",body:JSON.stringify({start:t,end:r,arrivalWindowStart:t,arrivalWindowEnd:r})},!0);return console.log("[ServiceTitan] Appointment rescheduled successfully"),a.data}catch(e){throw console.error("[ServiceTitan] Reschedule appointment error:",e),e}}async getCustomerAppointments(e){try{let t=`https://api.servicetitan.io/jpm/v2/tenant/${this.config.tenantId}/jobs?customerId=${e}&pageSize=50`,r=((await this.request(t,{},!0)).data||[]).map(async e=>{try{if(!e.firstAppointmentId&&!e.lastAppointmentId)return[];let t=`https://api.servicetitan.io/jpm/v2/tenant/${this.config.tenantId}/appointments?jobId=${e.id}&pageSize=50`;return((await this.request(t,{},!0)).data||[]).map(t=>({id:t.id,start:t.start||t.scheduledOn||t.arrivalWindowStart,end:t.end||t.arrivalWindowEnd,status:t.appointmentStatus||t.status||"Scheduled",arrivalWindowStart:t.arrivalWindowStart,arrivalWindowEnd:t.arrivalWindowEnd,jobType:e.jobType||"Service Call",jobNumber:e.jobNumber,summary:e.summary||t.summary||`Appointment for Job #${e.jobNumber}`}))}catch(t){return console.log(`[ServiceTitan] Could not fetch appointments for job ${e.id}, using job data`),[{id:e.id,start:e.createdOn,end:e.completedOn,status:e.jobStatus||"Unknown",arrivalWindowStart:null,arrivalWindowEnd:null,jobType:"Service Call",jobNumber:e.jobNumber,summary:e.summary||`Job #${e.jobNumber}`}]}});return(await Promise.all(r)).flat()}catch(e){return console.error("[ServiceTitan] Get customer appointments error:",e),[]}}async getCustomerInvoices(e){try{let t=`https://api.servicetitan.io/accounting/v2/tenant/${this.config.tenantId}/invoices?customerId=${e}&pageSize=50`,r=await this.request(t,{},!0);return console.log("[ServiceTitan] Invoices response structure:",JSON.stringify(r,null,2).substring(0,500)),(r.data||[]).map(e=>({id:e.id,invoiceNumber:e.referenceNumber||e.id?.toString(),total:parseFloat(e.total||"0"),balance:parseFloat(e.balance||"0"),status:"0.00"===e.balance||0===e.balance?"Paid":"Outstanding",createdOn:e.invoiceDate||e.createdOn,dueDate:e.dueDate||null,jobNumber:e.referenceNumber||null,summary:e.summary||`Invoice #${e.referenceNumber||e.id}`}))}catch(e){return console.error("[ServiceTitan] Get customer invoices error:",e),[]}}async getCustomerMemberships(e){try{let t=`https://api.servicetitan.io/memberships/v2/tenant/${this.config.tenantId}/memberships?customerIds=${e}&active=Any&pageSize=50`,r=await this.request(t,{},!0);console.log("[ServiceTitan] Memberships API response:",{totalCount:r.data?.length||0,memberships:r.data?.map(e=>({id:e.id,status:e.status,name:e.name,duration:e.duration,billingFrequency:e.billingFrequency,createdOn:e.createdOn,modifiedOn:e.modifiedOn,active:e.active}))||[]});let o=r.data||[],a=o.filter(e=>{if(!e.name&&!e.id)return!1;let t=(e.status||"").toLowerCase();return"deleted"!==t});console.log("[ServiceTitan] Filtered memberships (excluding canceled):",{inputCount:o.length,displayableCount:a.length,memberships:a.map(e=>({name:e.membershipName,status:e.status,expiresOn:e.to||e.expirationDate,canceledOn:e.canceledOn}))});let i=new Map;return a.forEach(e=>{let t=e.id,r=e.status||"Unknown",o=null!==e.duration&&void 0!==e.duration;i.set(t,{id:e.id,membershipType:e.name||"VIP Membership",status:r,isExpired:"Expired"===r||"Canceled"===r,startDate:e.createdOn,expirationDate:o?e.expirationDate:null,renewalDate:e.renewalDate,balance:0,totalValue:0,description:e.description||"",rawStatus:e.status,billingFrequency:e.billingFrequency,duration:e.duration,active:e.active})}),Array.from(i.values())}catch(e){return console.error("[ServiceTitan] Get customer memberships error:",e),[]}}async getCustomerEstimates(e){try{let t=`https://api.servicetitan.io/sales/v2/tenant/${this.config.tenantId}/estimates?customerId=${e}&pageSize=50`,r=await this.request(t,{},!0);console.log("[ServiceTitan] Estimates API response received:",{totalCount:r.data?.length||0,statuses:r.data?.map(e=>({id:e.id,status:e.status,soldOn:e.soldOn}))||[]});let o=r.data||[],a=o.filter(e=>!e.soldOn);console.log(`[ServiceTitan] Filtered to ${a.length} unsold estimates from ${o.length} total`);let i=new Map;return await Promise.all(a.map(async e=>{let t=e.items||[],r=await Promise.all(t.map(async e=>{let t=null;try{let r="";if(e.serviceId||e.skuId){let o=e.serviceId||e.skuId;if(r=`service-${o}`,!i.has(r)){let e=await this.getPricebookService(o);i.set(r,e)}t=i.get(r)}else if(e.materialId){if(r=`material-${e.materialId}`,!i.has(r)){let t=await this.getPricebookMaterial(e.materialId);i.set(r,t)}t=i.get(r)}else if(e.equipmentId){if(r=`equipment-${e.equipmentId}`,!i.has(r)){let t=await this.getPricebookEquipment(e.equipmentId);i.set(r,t)}t=i.get(r)}}catch(r){console.error("[ServiceTitan] Error fetching pricebook details for item:",e,r),t=null}return{...e,quantity:e.qty||1,unitRate:e.unitRate||0,total:e.total||0,description:e.description||"",pricebookDetails:t}})),o=new Date(e.createdOn||e.createdDate),a=new Date(e.expiresOn||e.expirationDate?e.expiresOn||e.expirationDate:o.getTime()+2592e6),n=new Date,s=Math.ceil((a.getTime()-n.getTime())/864e5),c="valid";return s<0?c="expired":s<=7&&(c="expiring_soon"),{id:e.id,estimateNumber:e.number||e.estimateNumber||e.id?.toString(),total:parseFloat(e.total||e.subtotal||"0"),status:"object"==typeof e.status&&e.status?.name?e.status.name:e.status||"Open",createdOn:e.createdOn||e.createdDate,expiresOn:a.toISOString(),expirationStatus:c,daysUntilExpiration:s,jobId:e.jobId,jobNumber:e.job?.jobNumber||null,summary:e.name||e.summary||`Estimate #${e.number||e.id}`,items:r}}))}catch(e){return console.error("[ServiceTitan] Get customer estimates error:",e),[]}}async getPricebookService(e){try{let t=`https://api.servicetitan.io/pricebook/v2/tenant/${this.config.tenantId}/services/${e}`,r=await this.request(t,{},!0);return{id:r.id,name:r.name||r.displayName,description:r.description,price:parseFloat(r.price||"0"),imageUrl:r.imageUrl||r.image||null,category:r.category||r.categoryName,type:"service"}}catch(t){return console.error(`[ServiceTitan] Error fetching pricebook service ${e}:`,t),null}}async getPricebookMaterial(e){try{let t=`https://api.servicetitan.io/pricebook/v2/tenant/${this.config.tenantId}/materials/${e}`,r=await this.request(t,{},!0);return{id:r.id,name:r.name||r.displayName,description:r.description,price:parseFloat(r.price||r.cost||"0"),imageUrl:r.imageUrl||r.image||null,category:r.category||r.categoryName,type:"material"}}catch(t){return console.error(`[ServiceTitan] Error fetching pricebook material ${e}:`,t),null}}async getPricebookEquipment(e){try{let t=`https://api.servicetitan.io/pricebook/v2/tenant/${this.config.tenantId}/equipment/${e}`,r=await this.request(t,{},!0);return{id:r.id,name:r.name||r.displayName,description:r.description,price:parseFloat(r.price||r.cost||"0"),imageUrl:r.imageUrl||r.image||null,category:r.category||r.categoryName,type:"equipment"}}catch(t){return console.error(`[ServiceTitan] Error fetching pricebook equipment ${e}:`,t),null}}async getPricebookItemImage(e){try{if(!e)return null;return`https://api.servicetitan.io/pricebook/v2/tenant/${this.config.tenantId}/images?path=${encodeURIComponent(e)}`}catch(t){return console.error(`[ServiceTitan] Error getting pricebook image ${e}:`,t),null}}async syncAllCustomers(){let r=Date.now();console.log("[ServiceTitan Sync] Starting full customer sync...");try{let{customersXlsx:o,contactsXlsx:a}=await e.A(24067),{eq:s}=await e.A(496359),c=1,l=!0,m=0,u=0;for(console.log("[ServiceTitan Sync] Using upsert strategy for zero-downtime sync..."),console.log("[ServiceTitan Sync] Will also fetch job counts for each customer...");l;){console.log(`[ServiceTitan Sync] Fetching page ${c}...`);let r=await this.request(`/customers?page=${c}&pageSize=200`),d=r.data||[];if(l=r.hasMore||!1,0===d.length)break;let h=0,p=0,g=[],y=0;for(let e=0;e<d.length;e++){let r=d[e];if(!1===r.active){y++;continue}(e+1)%10==0&&console.log(`[ServiceTitan Sync] Processing customer ${e+1}/${d.length}...`);try{let e=0;try{let t=`https://api.servicetitan.io/jpm/v2/tenant/${this.config.tenantId}`,o=1,a=!0;for(;a;){let i=await fetch(`${t}/jobs?customerId=${r.id}&jobStatus=Completed&page=${o}&pageSize=100`,{headers:{Authorization:`Bearer ${this.accessToken}`,"ST-App-Key":this.config.appKey,"Content-Type":"application/json"}});if(i.ok){let t=await i.json();if(t.data&&t.data.length>0&&(e+=t.data.length),a=t.hasMore||!1,++o>50){console.log(`[ServiceTitan Sync] âš ï¸ Customer ${r.id} has over 5000 jobs, stopping pagination`);break}}else a=!1}e>0&&(h++,p+=e),e>100&&(console.log(`[ServiceTitan Sync] ðŸŒŸ High-value customer: ${r.name} (ID: ${r.id}) - ${e} completed jobs`),g.push({id:r.id,name:r.name||"Unknown",jobCount:e}))}catch(e){}for(let c of(await t.db.insert(o).values({id:r.id,name:r.name||"Unknown",type:r.type||"Residential",street:r.address?.street||null,city:r.address?.city||null,state:r.address?.state||null,zip:r.address?.zip||null,active:r.active??!0,balance:r.balance?.toString()||"0.00",jobCount:e}).onConflictDoUpdate({target:o.id,set:{name:r.name||"Unknown",type:r.type||"Residential",street:r.address?.street||null,city:r.address?.city||null,state:r.address?.state||null,zip:r.address?.zip||null,active:r.active??!0,balance:r.balance?.toString()||"0.00",jobCount:e,lastSyncedAt:new Date}}),m++,e>0&&h++,await t.db.delete(a).where(s(a.customerId,r.id)),await this.getCustomerContacts(r.id))){let e=c.type||"Unknown",o=c.value||c.phoneNumber||c.email||"";if(!o)continue;let s="";(s=e.toLowerCase().includes("phone")||e.toLowerCase().includes("mobile")?i(o):e.toLowerCase().includes("email")?n(o):o.toLowerCase().trim())&&(await t.db.insert(a).values({customerId:r.id,contactType:e,value:o,normalizedValue:s,isPrimary:!1}).onConflictDoNothing(),u++)}}catch(e){console.error(`[ServiceTitan Sync] Error processing customer ${r.id}:`,e)}}(g.length>0||y>0)&&(console.log(`[ServiceTitan Sync] Page ${c-1} Summary:`),console.log(`  - Customers with jobs: ${h}/${d.length}`),console.log(`  - Total jobs counted: ${p}`),console.log(`  - High-value customers (100+ jobs): ${g.length}`),y>0&&console.log(`  - Skipped inactive/deactivated: ${y}`),g.slice(0,3).forEach(e=>{console.log(`    â€¢ ${e.name}: ${e.jobCount} jobs`)})),c++;let{updateSyncHeartbeat:v}=await e.A(142913);v(),c%10==0&&console.log(`[ServiceTitan Sync] Progress: ${m} customers, ${u} contacts, ${h} with jobs`)}let d=Date.now()-r;return console.log(`[ServiceTitan Sync] âœ… Completed! ${m} customers, ${u} contacts in ${(d/1e3).toFixed(1)}s`),console.log(`[ServiceTitan Sync] ðŸ“Š 0 customers have completed jobs`),{customersCount:m,contactsCount:u,duration:d}}catch(e){throw console.error("[ServiceTitan Sync] Failed:",e),e}}async searchLocalCustomer(r){try{let{contactsXlsx:o}=await e.A(24067),{eq:a,or:s,sql:c}=await e.A(496359),l=r.includes("@")?n(r):i(r);if(!l)return[];let m=await t.db.select({customerId:o.customerId}).from(o).where(s(a(o.normalizedValue,l),c`${o.normalizedValue} LIKE ${"%"+l+"%"}`));return Array.from(new Set(m.map(e=>e.customerId)))}catch(e){return console.error("[ServiceTitan] Local search error:",e),[]}}async searchAllMatchingCustomers(r){try{let{contactsXlsx:o,customersXlsx:a}=await e.A(24067),{eq:s,or:c,sql:l,inArray:m}=await e.A(496359),u=r.includes("@")?n(r):i(r);if(!u)return[];let d=await t.db.select({customerId:o.customerId}).from(o).where(c(s(o.normalizedValue,u),l`${o.normalizedValue} LIKE ${"%"+u+"%"}`));if(0===d.length)return console.log("[ServiceTitan] No matching customers in cache"),[];let h=Array.from(new Set(d.map(e=>e.customerId)));return console.log(`[ServiceTitan] Found ${h.length} matching customer(s) in cache`),(await t.db.select().from(a).where(m(a.id,h))).map(e=>({id:e.id,name:e.name||"Unknown",type:e.type||"Residential",email:e.email||void 0,phone:e.phone||void 0,mobilePhone:e.mobilePhone||void 0,address:[e.street,e.city,e.state,e.zip].filter(Boolean).join(", ")}))}catch(e){return console.error("[ServiceTitan] Search all matching customers error:",e),[]}}async searchCustomerWithFallback(r){let o=await this.searchLocalCustomer(r);if(o.length>0)return console.log(`[ServiceTitan] âœ… Found ${o.length} customer(s) in local cache, returning first`),o[0];console.log("[ServiceTitan] ðŸ”„ Not in cache, searching live API...");let a=r.includes("@"),s=a?r:"",c=a?"":r;console.log(`[ServiceTitan] Searching with ${a?"email":"phone"}: "${r}"`);let l=await this.searchCustomer(s,c);if(l){console.log(`[ServiceTitan] âœ… Found customer ${l.id} via live API, caching...`);try{let{customersXlsx:r,contactsXlsx:o}=await e.A(24067);await t.db.insert(r).values({id:l.id,name:l.name||"Unknown",type:l.type||"Residential",email:l.email||null,phone:l.phoneNumber||null,street:l.address?.street||null,city:l.address?.city||null,state:l.address?.state||null,zip:l.address?.zip||null,active:!0,balance:"0.00"}).onConflictDoUpdate({target:r.id,set:{email:l.email||null,phone:l.phoneNumber||null,lastSyncedAt:new Date}});let a=await this.getCustomerContacts(l.id);for(let e of a){let r=e.type||"Unknown",a=e.value||e.phoneNumber||e.email||"";if(!a)continue;let s="";(s=r.toLowerCase().includes("phone")||r.toLowerCase().includes("mobile")?i(a):r.toLowerCase().includes("email")?n(a):a.toLowerCase().trim())&&await t.db.insert(o).values({customerId:l.id,contactType:r,value:a,normalizedValue:s,isPrimary:!1}).onConflictDoNothing()}if(l.email){let e=n(l.email);e&&await t.db.insert(o).values({customerId:l.id,contactType:"Email",value:l.email,normalizedValue:e,isPrimary:!0}).onConflictDoNothing()}if(l.phoneNumber){let e=i(l.phoneNumber);e&&await t.db.insert(o).values({customerId:l.id,contactType:"Phone",value:l.phoneNumber,normalizedValue:e,isPrimary:!0}).onConflictDoNothing()}console.log(`[ServiceTitan] âœ… Cached customer ${l.id} with ${a.length} contacts from API + customer record email/phone`)}catch(e){console.error("[ServiceTitan] Failed to cache customer:",e)}return l.id}return console.log("[ServiceTitan] âŒ Customer not found in cache or live API"),null}async getCustomerJobs(e,t){try{let r=`https://api.servicetitan.io/jpm/v2/tenant/${this.config.tenantId}`,o=`${r}/jobs?customerId=${e}`;if(t){let e=t.toISOString().split("T")[0];o+=`&completedOnOrAfter=${e}`}return console.log("[ServiceTitan] Fetching jobs for customer",e,"after",t),(await this.request(o,{},!0)).data.map(e=>({id:e.id,jobNumber:e.jobNumber,customerId:e.customerId,completedOn:e.completedOn||null,total:e.total,status:e.jobStatus}))}catch(e){throw console.error("[ServiceTitan] Error fetching customer jobs:",e),e}}async createCustomerCredit(e,t,r){try{let o=`https://api.servicetitan.io/accounting/v2/tenant/${this.config.tenantId}`,a=`${o}/customer-adjustments`;console.log("[ServiceTitan] Creating customer credit:",{customerId:e,amount:t,memo:r});let i=await this.request(a,{method:"POST",body:JSON.stringify({customerId:e,amount:t,type:"Credit",memo:r,date:new Date().toISOString()})},!0);return console.log("[ServiceTitan] âœ… Credit created successfully:",i.id),i}catch(e){throw console.error("[ServiceTitan] Error creating customer credit:",e),e}}async createCustomerNote(e,t,r=!0){try{let o=`/customers/${e}/notes`;console.log("[ServiceTitan] Creating customer note:",{customerId:e,noteText:t.substring(0,50)+"...",pinToTop:r});let a=await this.request(o,{method:"POST",body:JSON.stringify({text:t,pinToTop:r})});return console.log("[ServiceTitan] âœ… Note created successfully:",a.id),a}catch(e){throw console.error("[ServiceTitan] Error creating customer note:",e),e}}async getCustomerNotes(e){try{let t=`/customers/${e}/notes`;return(await this.request(t)).data||[]}catch(e){return console.error("[ServiceTitan] Error fetching customer notes:",e),[]}}async updateCustomerNote(e,t,r,o=!0){try{let a=`/customers/${e}/notes/${t}`;console.log("[ServiceTitan] Updating customer note:",{customerId:e,noteId:t,noteText:r.substring(0,50)+"..."}),await this.request(a,{method:"PUT",body:JSON.stringify({text:r,pinToTop:o})}),console.log("[ServiceTitan] âœ… Note updated successfully")}catch(e){throw console.error("[ServiceTitan] Error updating customer note:",e),e}}async fetchJobsIncremental(e,t=250){try{let r=`https://api.servicetitan.io/jpm/v2/tenant/${this.config.tenantId}`,o=`${r}/jobs?pageSize=${t}`;if(e){let t=e.toISOString();o+=`&modifiedOnOrAfter=${t}`,console.log("[ServiceTitan Jobs Sync] ðŸ“¥ Fetching jobs modified after:",t)}else console.log("[ServiceTitan Jobs Sync] ðŸ“¥ Fetching ALL jobs (initial sync)");let a=await this.request(o,{},!0),i=null;if(a.data&&a.data.length>0){let e=a.data.map(e=>new Date(e.modifiedOn));i=new Date(Math.max(...e.map(e=>e.getTime())))}return console.log("[ServiceTitan Jobs Sync] âœ… Fetched",a.data?.length||0,"jobs"),{jobs:a.data||[],hasMore:a.hasMore||!1,highestModifiedOn:i}}catch(e){throw console.error("[ServiceTitan Jobs Sync] âŒ Error fetching jobs:",e),e}}async syncAllJobs(){let r=Date.now(),{serviceTitanJobsStaging:o,serviceTitanJobs:a,customersXlsx:i,syncWatermarks:n}=await e.A(24067),{eq:s,sql:c}=await e.A(496359);try{console.log("[ServiceTitan Jobs Sync] ðŸš€ Starting incremental job sync...");let e=await t.db.select().from(n).where(s(n.syncType,"jobs")).limit(1),i=e[0]?.lastModifiedOnFetched||null,l=0,m=!0,u=i;for(;m;){let{jobs:e,hasMore:r,highestModifiedOn:i}=await this.fetchJobsIncremental(u||void 0,250);if(0===e.length)break;for(let r of e)await t.db.insert(o).values({jobId:r.id,rawData:r,fetchedAt:new Date}).onConflictDoUpdate({target:o.jobId,set:{rawData:r,fetchedAt:new Date}});for(let e of(await t.db.select().from(o).where(s(o.processedAt,null))))try{let r=e.rawData;await t.db.insert(a).values({id:r.id,jobNumber:r.jobNumber,customerId:r.customerId,jobType:r.jobType||null,businessUnitId:r.businessUnitId||null,jobStatus:r.jobStatus,completedOn:r.completedOn?new Date(r.completedOn):null,total:Math.round(100*(r.total||0)),invoice:Math.round(100*(r.invoice||0)),createdOn:new Date(r.createdOn),modifiedOn:new Date(r.modifiedOn),lastSyncedAt:new Date}).onConflictDoUpdate({target:a.id,set:{jobNumber:r.jobNumber,jobType:r.jobType||null,jobStatus:r.jobStatus,completedOn:r.completedOn?new Date(r.completedOn):null,total:Math.round(100*(r.total||0)),invoice:Math.round(100*(r.invoice||0)),modifiedOn:new Date(r.modifiedOn),lastSyncedAt:new Date}}),await t.db.update(o).set({processedAt:new Date}).where(s(o.id,e.id))}catch(r){console.error("[ServiceTitan Jobs Sync] âŒ Error processing job:",r),await t.db.update(o).set({processingError:r.message}).where(s(o.id,e.id))}l+=e.length,i&&(u=i),m=r}console.log("[ServiceTitan Jobs Sync] ðŸ“Š Updating customer job counts..."),await t.db.execute(c`
        UPDATE customers_xlsx c
        SET job_count = (
          SELECT COUNT(*)
          FROM service_titan_jobs j
          WHERE j.customer_id = c.id
            AND j.job_status = 'Completed'
            AND j.completed_on IS NOT NULL
        )
      `);let d=await t.db.execute(c`
        SELECT COUNT(*) as count 
        FROM customers_xlsx 
        WHERE job_count > 0
      `),h=d.rows[0]?.count||0;await t.db.update(n).set({lastSuccessfulSyncAt:new Date,lastModifiedOnFetched:u,recordsProcessed:l,syncDuration:Date.now()-r,updatedAt:new Date}).where(s(n.syncType,"jobs"));let p=Date.now()-r;return console.log("[ServiceTitan Jobs Sync] âœ… Sync complete!"),console.log(`  - Jobs synced: ${l}`),console.log(`  - Customers with jobs: ${h}`),console.log(`  - Duration: ${(p/1e3).toFixed(1)}s`),{jobsCount:l,customersUpdated:Number(h),duration:p}}catch(o){let{eq:r}=await e.A(496359);throw await t.db.update(n).set({lastError:o.message,lastErrorAt:new Date,updatedAt:new Date}).where(r(n.syncType,"jobs")),o}}async getJobForms(e){try{let t=`https://api.servicetitan.io/forms/v2/tenant/${this.config.tenantId}/jobs/${e}/forms`;return(await this.request(t,{},!0)).data||[]}catch(t){return console.error(`[ServiceTitan Forms] Error fetching forms for job ${e}:`,t),[]}}async syncJobForms(r={}){let o=Date.now(),{serviceTitanJobForms:a,serviceTitanJobs:i}=await e.A(24067),{eq:n,sql:s,inArray:c}=await e.A(496359);try{console.log("[ServiceTitan Forms Sync] ðŸ”„ Starting forms sync...");let e=[];if(r.jobIds&&r.jobIds.length>0)console.log(`[ServiceTitan Forms Sync] Syncing ${r.jobIds.length} specific jobs`),e=await t.db.select().from(i).where(c(i.id,r.jobIds)).limit(r.batchSize||100);else{let o=r.sinceDate||new Date(Date.now()-2592e6);console.log(`[ServiceTitan Forms Sync] Syncing jobs modified since ${o.toISOString()}`),e=await t.db.select().from(i).where(s`${i.modifiedOn} >= ${o}`).orderBy(s`${i.modifiedOn} DESC`).limit(r.batchSize||100)}console.log(`[ServiceTitan Forms Sync] ðŸ“Š Processing ${e.length} jobs...`);let n=0,l=0;for(let r=0;r<e.length;r+=10){let o=e.slice(r,r+10);await Promise.all(o.map(async r=>{try{let o=await this.getJobForms(r.id);if(0===o.length)return;for(let e of o)try{let o=this.parseFormFields(e),i=this.extractTechnicianNotes(o),s=this.extractCustomerConcerns(o),c=this.extractRecommendations(o),l=this.extractEquipmentCondition(o);await t.db.insert(a).values({formId:e.id,jobId:r.id,customerId:r.customerId,formTemplateId:e.formTemplate?.id||null,formTemplateName:e.formTemplate?.name||null,rawFormData:e,parsedFields:o,technicianNotes:i,customerConcerns:s,recommendationsMade:c,equipmentCondition:l,submittedOn:e.submittedOn?new Date(e.submittedOn):new Date,submittedBy:e.submittedBy?.name||null,lastSyncedAt:new Date}).onConflictDoUpdate({target:a.formId,set:{rawFormData:e,parsedFields:o,technicianNotes:i,customerConcerns:s,recommendationsMade:c,equipmentCondition:l,lastSyncedAt:new Date}}),n++}catch(t){console.error(`[ServiceTitan Forms Sync] Error processing form ${e.id}:`,t)}++l%20==0&&console.log(`[ServiceTitan Forms Sync] Progress: ${l}/${e.length} jobs processed`)}catch(e){console.error(`[ServiceTitan Forms Sync] Error syncing forms for job ${r.id}:`,e)}}))}let m=Date.now()-o;return console.log("[ServiceTitan Forms Sync] âœ… Sync complete!"),console.log(`  - Jobs processed: ${l}`),console.log(`  - Forms synced: ${n}`),console.log(`  - Duration: ${(m/1e3).toFixed(1)}s`),{formsCount:n,jobsProcessed:l,duration:m}}catch(e){throw console.error("[ServiceTitan Forms Sync] âŒ Sync failed:",e),e}}parseFormFields(e){let t={};if(!e.fields||!Array.isArray(e.fields))return t;for(let r of e.fields)t[r.name||r.label||`field_${r.id}`]=r.value||r.text||r.selectedOption||null;return t}extractTechnicianNotes(e){let t=["technician_notes","notes","tech_notes","comments","observations","findings","service_notes","job_notes"],r=[];for(let[o,a]of Object.entries(e)){let e=o.toLowerCase().replace(/[^a-z]/g,"");t.some(t=>e.includes(t.replace(/_/g,"")))&&a&&r.push(String(a))}return r.length>0?r.join("\n\n"):null}extractCustomerConcerns(e){let t=[],r=["concern","issue","problem","complaint","worry"];for(let[o,a]of Object.entries(e)){let e=o.toLowerCase();r.some(t=>e.includes(t))&&a&&t.push(String(a))}return t}extractRecommendations(e){let t=[],r=["recommend","suggestion","should replace","needs replacement","should consider","advise"];for(let[o,a]of Object.entries(e)){let e=o.toLowerCase(),i=String(a||"").toLowerCase();r.some(t=>e.includes(t)||i.includes(t))&&a&&t.push(String(a))}return t}extractEquipmentCondition(e){let t=["condition","status","quality","state"];for(let[r,o]of Object.entries(e)){let e=r.toLowerCase();if(t.some(t=>e.includes(t))&&o){let e=String(o).toLowerCase();if(e.includes("critical")||e.includes("failure"))return"Critical";if(e.includes("poor")||e.includes("bad"))return"Poor";if(e.includes("fair")||e.includes("okay"))return"Fair";if(e.includes("good"))return"Good";if(e.includes("excellent")||e.includes("great"))return"Excellent";return String(o)}}return null}async getCampaigns(){try{let e=`https://api.servicetitan.io/marketing/v2/tenant/${this.config.tenantId}/campaigns`,t=await this.request(e,{},!0);return t.data||t||[]}catch(e){throw console.error("[ServiceTitan] Get campaigns error:",e),e}}async getCampaign(e){try{let t=`https://api.servicetitan.io/marketing/v2/tenant/${this.config.tenantId}/campaigns/${e}`;return await this.request(t,{},!0)}catch(e){throw console.error("[ServiceTitan] Get campaign error:",e),e}}async createCampaign(e){try{let t=`https://api.servicetitan.io/marketing/v2/tenant/${this.config.tenantId}/campaigns`,r={name:e.name,active:e.active??!0,...e.categoryId&&{categoryId:e.categoryId},...e.businessUnitId&&{businessUnitId:e.businessUnitId},...e.phoneNumber&&{phoneNumber:e.phoneNumber}};console.log("[ServiceTitan] Creating campaign:",r);let o=await this.request(t,{method:"POST",body:JSON.stringify(r)},!0);return console.log("[ServiceTitan] Campaign created:",o),{id:o.id||o.data?.id,name:o.name||o.data?.name||e.name}}catch(e){throw console.error("[ServiceTitan] Create campaign error:",e),e}}async getCampaignCategories(){try{let e=`https://api.servicetitan.io/marketing/v2/tenant/${this.config.tenantId}/campaign-categories`,t=await this.request(e,{},!0);return t.data||t||[]}catch(e){throw console.error("[ServiceTitan] Get campaign categories error:",e),e}}async updateCampaignCost(e,t){try{let r=`https://api.servicetitan.io/marketing/v2/tenant/${this.config.tenantId}/campaigns/${e}/costs`;await this.request(r,{method:"POST",body:JSON.stringify(t)},!0),console.log("[ServiceTitan] Campaign cost updated")}catch(e){throw console.error("[ServiceTitan] Update campaign cost error:",e),e}}async getAllCustomersMap(){try{console.log("[ServiceTitan] Fetching all customers for lookup map...");let e=new Map,t=1,r=!0;for(;r&&t<100;){let o=`https://api.servicetitan.io/crm/v2/tenant/${this.config.tenantId}/customers?page=${t}&pageSize=500`,a=await this.request(o,{},!0),i=a.data||[];if(console.log(`[ServiceTitan] Page ${t}: Fetched ${i.length} customers`),i.forEach(t=>{let r=t.name||t.companyName||`Customer #${t.id}`;e.set(t.id,r)}),r=a.hasMore||!1,t++,i.length<500)break}return console.log(`[ServiceTitan] Created customer lookup map with ${e.size} customers`),e}catch(e){return console.error("[ServiceTitan] Error fetching customer map:",e),new Map}}async getAllMemberships(){try{console.log("[ServiceTitan Memberships] Fetching all customer memberships...");let e=await this.getAllCustomersMap(),t=`https://api.servicetitan.io/memberships/v2/tenant/${this.config.tenantId}/recurring-service-events?pageSize=500`,r=await this.request(t,{},!0),o=r.data||[],a=1,i=r.hasMore||!1;for(;i&&a<10;){a++;let e=`${t}&page=${a}`,r=await this.request(e,{},!0);o=[...o,...r.data||[]],i=r.hasMore||!1}return console.log(`[ServiceTitan Memberships] Fetched ${o.length} total memberships`),o.map(t=>({id:t.id,customerId:t.customerId,customerName:e.get(t.customerId)||t.customerName||"Unknown Customer",membershipId:t.membershipId,membershipName:t.membershipName||t.locationRecurringServiceName||"VIP Membership",status:t.status||"Unknown",startDate:t.from||t.createdOn,expirationDate:t.to||t.expirationDate,renewalDate:t.date||t.nextScheduledDate,balance:parseFloat(t.balance||"0"),totalValue:parseFloat(t.total||"0"),description:t.memo||t.description||"",createdOn:t.createdOn,modifiedOn:t.modifiedOn,rawData:t}))}catch(e){throw console.error("[ServiceTitan Memberships] Error fetching all memberships:",e),e}}async updateMembershipStatus(e,t){try{console.log(`[ServiceTitan Memberships] Updating membership ${e}:`,t);let r=`https://api.servicetitan.io/memberships/v2/tenant/${this.config.tenantId}/customer-memberships/${e}`,o={};t.status&&(o.status=t.status),t.expirationDate&&(o.to=t.expirationDate),t.cancellationDate&&(o.cancellationDate=t.cancellationDate);let a=await this.request(r,{method:"PATCH",body:JSON.stringify(o)},!0);return console.log(`[ServiceTitan Memberships] Membership ${e} updated successfully`),a}catch(t){throw console.error(`[ServiceTitan Memberships] Error updating membership ${e}:`,t),t}}async bulkUpdateMemberships(e){console.log(`[ServiceTitan Memberships] Bulk updating ${e.length} memberships...`);let t=0,r=0,o=[];for(let a of e)try{await this.updateMembershipStatus(a.membershipId,{status:a.status,expirationDate:a.expirationDate,cancellationDate:a.cancellationDate}),t++}catch(e){r++,o.push({membershipId:a.membershipId,error:e instanceof Error?e.message:"Unknown error"})}return console.log(`[ServiceTitan Memberships] Bulk update complete: ${t} succeeded, ${r} failed`),{success:t,failed:r,errors:o}}}let o=null;function a(){if(!o){let e=process.env.SERVICETITAN_CLIENT_ID,t=process.env.SERVICETITAN_CLIENT_SECRET,a=process.env.SERVICETITAN_TENANT_ID,i=process.env.SERVICETITAN_APP_KEY;if(!e||!t||!a||!i)throw Error("ServiceTitan credentials not configured");o=new r({clientId:e,clientSecret:t,tenantId:a,appKey:i})}return o}function i(e){if(!e)return"";let t=e.replace(/\s*(x|ext\.?|extension|#)\s*\d+/gi,"").replace(/\D/g,"");return 11===t.length&&t.startsWith("1")?t.substring(1):t}function n(e){return e?e.trim().toLowerCase():""}e.s(["ServiceTitanAPI",()=>r,"getServiceTitanAPI",()=>a,"normalizeEmail",()=>n,"normalizePhone",()=>i])}];

//# sourceMappingURL=server_lib_serviceTitan_ts_b2dfaf2e._.js.map