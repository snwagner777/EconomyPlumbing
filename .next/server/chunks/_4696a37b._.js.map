{"version":3,"sources":["turbopack:///[project]/server/lib/serviceTitanSync.ts"],"sourcesContent":["import { getServiceTitanAPI } from \"./serviceTitan\";\n\n// Mutex to prevent concurrent syncs\nlet syncInProgress = false;\nlet lastSyncHeartbeat = Date.now();\n\n/**\n * Check if a ServiceTitan sync is currently running\n */\nexport function isSyncRunning(): boolean {\n  // If sync has been \"running\" for more than 30 minutes without heartbeat, consider it stale\n  if (syncInProgress && Date.now() - lastSyncHeartbeat > 30 * 60 * 1000) {\n    console.log('[ServiceTitan Sync] ‚ö†Ô∏è  Detected stale sync lock (no heartbeat for 30min), resetting...');\n    syncInProgress = false;\n  }\n  return syncInProgress;\n}\n\n/**\n * Reset the sync mutex (admin tool only)\n */\nexport function resetSyncLock(): void {\n  console.log('[ServiceTitan Sync] üîì Manually resetting sync lock...');\n  syncInProgress = false;\n  lastSyncHeartbeat = Date.now();\n}\n\n/**\n * Update heartbeat to prevent stale lock detection\n */\nexport function updateSyncHeartbeat(): void {\n  lastSyncHeartbeat = Date.now();\n}\n\n/**\n * Sync all customers from ServiceTitan to local database\n * Protected by mutex to prevent concurrent execution\n */\nexport async function syncServiceTitanCustomers(): Promise<void> {\n  // Check if sync is already running\n  if (syncInProgress) {\n    console.log('[ServiceTitan Sync] ‚è≠Ô∏è  Sync already in progress, skipping...');\n    return;\n  }\n\n  try {\n    syncInProgress = true;\n    console.log('[ServiceTitan Sync] Starting customer sync...');\n    \n    const serviceTitan = getServiceTitanAPI();\n    const result = await serviceTitan.syncAllCustomers();\n    \n    console.log(`[ServiceTitan Sync] ‚úÖ Customer sync completed!`);\n    console.log(`[ServiceTitan Sync] - Customers synced: ${result.customersCount}`);\n    console.log(`[ServiceTitan Sync] - Contacts synced: ${result.contactsCount}`);\n    console.log(`[ServiceTitan Sync] - Duration: ${(result.duration / 1000).toFixed(1)}s`);\n  } catch (error) {\n    console.error('[ServiceTitan Sync] ‚ùå Customer sync failed:', error);\n  } finally {\n    syncInProgress = false;\n  }\n}\n\n/**\n * Sync all data from ServiceTitan to local database (customers + jobs)\n * Protected by mutex to prevent concurrent execution\n */\nexport async function syncServiceTitanData(): Promise<void> {\n  // Check if sync is already running\n  if (syncInProgress) {\n    console.log('[ServiceTitan Sync] ‚è≠Ô∏è  Sync already in progress, skipping...');\n    return;\n  }\n\n  try {\n    syncInProgress = true;\n    const startTime = Date.now();\n    console.log('[ServiceTitan Sync] üöÄ Starting full data sync (customers + jobs)...');\n    \n    const serviceTitan = getServiceTitanAPI();\n    \n    // Sync customers first\n    console.log('[ServiceTitan Sync] üìã Phase 1/2: Syncing customers...');\n    updateSyncHeartbeat();\n    const customerResult = await serviceTitan.syncAllCustomers();\n    \n    console.log(`[ServiceTitan Sync] ‚úÖ Customer sync completed!`);\n    console.log(`[ServiceTitan Sync] - Customers synced: ${customerResult.customersCount}`);\n    console.log(`[ServiceTitan Sync] - Contacts synced: ${customerResult.contactsCount}`);\n    console.log(`[ServiceTitan Sync] - Customer sync duration: ${(customerResult.duration / 1000).toFixed(1)}s`);\n    \n    // Sync jobs\n    console.log('[ServiceTitan Sync] üìã Phase 2/2: Syncing jobs...');\n    updateSyncHeartbeat();\n    const jobResult = await serviceTitan.syncAllJobs();\n    \n    console.log(`[ServiceTitan Sync] ‚úÖ Job sync completed!`);\n    console.log(`[ServiceTitan Sync] - Jobs synced: ${jobResult.jobsCount}`);\n    console.log(`[ServiceTitan Sync] - Customers updated: ${jobResult.customersUpdated}`);\n    console.log(`[ServiceTitan Sync] - Job sync duration: ${(jobResult.duration / 1000).toFixed(1)}s`);\n    \n    const totalDuration = (Date.now() - startTime) / 1000;\n    console.log(`[ServiceTitan Sync] ‚ú® Full data sync completed in ${totalDuration.toFixed(1)}s`);\n  } catch (error) {\n    console.error('[ServiceTitan Sync] ‚ùå Data sync failed:', error);\n  } finally {\n    syncInProgress = false;\n  }\n}\n\n/**\n * Start the ServiceTitan data sync scheduler\n * - Full sync every 6 hours (for complete data integrity)\n * - Runs initial sync on startup\n * - Syncs both customers and jobs\n */\nexport async function startServiceTitanSync(): Promise<void> {\n  console.log('[ServiceTitan Sync] Scheduler started - will sync customers and jobs every 6 hours');\n  \n  // Run initial full sync on startup\n  try {\n    const { customersXlsx, serviceTitanJobs } = await import('@shared/schema');\n    const { db } = await import('../db');\n    const { count } = await import('drizzle-orm');\n    \n    const customerResult = await db.select({ count: count() }).from(customersXlsx);\n    const customerCount = customerResult[0]?.count || 0;\n    \n    const jobResult = await db.select({ count: count() }).from(serviceTitanJobs);\n    const jobCount = jobResult[0]?.count || 0;\n    \n    console.log(`[ServiceTitan Sync] üöÄ Starting full data sync...`);\n    console.log(`[ServiceTitan Sync] üìä Current cache: ${customerCount} customers, ${jobCount} jobs`);\n    \n    // Run sync without blocking startup\n    syncServiceTitanData().catch(error => {\n      console.error('[ServiceTitan Sync] Initial sync failed:', error);\n    });\n  } catch (error) {\n    console.error('[ServiceTitan Sync] Failed to check data counts:', error);\n  }\n  \n  // Run full sync every 6 hours to keep cache fresh\n  setInterval(() => {\n    console.log('[ServiceTitan Sync] üîÑ Starting scheduled 6-hour data sync...');\n    syncServiceTitanData().catch(error => {\n      console.error('[ServiceTitan Sync] Scheduled sync failed:', error);\n    });\n  }, 6 * 60 * 60 * 1000); // 6 hours\n}\n"],"names":[],"mappings":"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"}