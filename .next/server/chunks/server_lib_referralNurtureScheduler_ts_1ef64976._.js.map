{"version":3,"sources":["turbopack:///[project]/server/lib/referralNurtureScheduler.ts","turbopack:///[project]/server/lib/aiEmailGenerator.ts"],"sourcesContent":["/**\n * Referral Nurture Campaign Scheduler\n * \n * Sends 4-email drip campaign over 6 months to encourage referrals:\n * - Email 1: Day 14 after review submission\n * - Email 2: Day 60 \n * - Email 3: Day 150\n * - Email 4: Day 210\n * \n * Features:\n * - Auto-creates campaigns when customers submit 4+ star reviews\n * - Auto-pauses after 2 consecutive unopened emails\n * - Tracks engagement and referral submissions\n * - Uses database templates or AI generation\n */\n\nimport { db } from \"../db\";\nimport { referralNurtureCampaigns, reviewEmailTemplates, systemSettings, emailSendLog } from \"../../shared/schema\";\nimport { eq, and, lt, or } from \"drizzle-orm\";\nimport { generateEmail, type GeneratedEmail } from \"./aiEmailGenerator\";\nimport { Resend } from \"resend\";\n\ninterface EmailSettings {\n  masterEmailEnabled: boolean;\n  reviewRequestEnabled: boolean;\n  referralNurturePhone: string | null;\n}\n\nexport class ReferralNurtureScheduler {\n  /**\n   * Create referral nurture campaign for a happy reviewer (4+ stars)\n   */\n  async createCampaignForReviewer(customerId: number, customerEmail: string, reviewRequestId: string): Promise<string | null> {\n    try {\n      // Check if campaign already exists for this customer\n      const existing = await db.query.referralNurtureCampaigns.findFirst({\n        where: eq(referralNurtureCampaigns.customerId, customerId),\n      });\n\n      if (existing) {\n        console.log(`[Referral Nurture] Campaign already exists for customer ${customerId}`);\n        return existing.id;\n      }\n\n      // Create new campaign\n      const [campaign] = await db\n        .insert(referralNurtureCampaigns)\n        .values({\n          customerId,\n          customerEmail,\n          originalReviewId: reviewRequestId,\n          status: 'queued',\n          createdAt: new Date(),\n        })\n        .returning();\n\n      console.log(`[Referral Nurture] Created campaign ${campaign.id} for customer ${customerId}`);\n      return campaign.id;\n    } catch (error) {\n      console.error(`[Referral Nurture] Error creating campaign for customer ${customerId}:`, error);\n      return null;\n    }\n  }\n\n  /**\n   * Get email settings from system_settings\n   */\n  private async getEmailSettings(): Promise<EmailSettings> {\n    try {\n      const dbSettings = await db.select().from(systemSettings);\n      const settingsMap = new Map(dbSettings.map(s => [s.key, s.value]));\n\n      return {\n        masterEmailEnabled: settingsMap.get('review_master_email_switch') === 'true',\n        reviewRequestEnabled: settingsMap.get('review_drip_enabled') === 'true',\n        referralNurturePhone: settingsMap.get('referral_nurture_phone_number') || null,\n      };\n    } catch (error) {\n      console.error(\"[Referral Nurture] Error fetching settings:\", error);\n      return {\n        masterEmailEnabled: false,\n        reviewRequestEnabled: false,\n        referralNurturePhone: null,\n      };\n    }\n  }\n\n  /**\n   * Check if referral nurture emails can be sent\n   */\n  private async canSendEmails(): Promise<{ allowed: boolean; reason?: string }> {\n    const settings = await this.getEmailSettings();\n\n    if (!settings.masterEmailEnabled) {\n      return { allowed: false, reason: 'Email system disabled' };\n    }\n\n    if (!settings.reviewRequestEnabled) {\n      return { allowed: false, reason: 'Review/referral drip campaigns disabled' };\n    }\n\n    if (!settings.referralNurturePhone) {\n      return { allowed: false, reason: 'Referral nurture phone number not configured' };\n    }\n\n    return { allowed: true };\n  }\n\n  /**\n   * Get email content for a specific email in the sequence\n   */\n  private async getEmailContent(\n    emailNumber: 1 | 2 | 3 | 4,\n    customerData: {\n      id: number;\n      customerName: string;\n      customerEmail: string;\n    },\n    settings: EmailSettings\n  ): Promise<GeneratedEmail> {\n    // Try to get template from database\n    const template = await db.query.reviewEmailTemplates.findFirst({\n      where: and(\n        eq(reviewEmailTemplates.campaignType, 'referral_nurture'),\n        eq(reviewEmailTemplates.emailNumber, emailNumber)\n      ),\n    });\n\n    if (template) {\n      console.log(`[Referral Nurture] Using database template for email ${emailNumber}`);\n      return {\n        subject: template.subject,\n        htmlContent: template.htmlContent,\n        plainTextContent: template.plainTextContent,\n      };\n    }\n\n    // Fall back to AI generation\n    console.log(`[Referral Nurture] Generating AI content for email ${emailNumber}`);\n    return await generateEmail({\n      campaignType: 'referral_nurture',\n      emailNumber,\n      customer: customerData,\n      phoneNumber: settings.referralNurturePhone!,\n    });\n  }\n\n  /**\n   * Send a single referral nurture email\n   */\n  async sendReferralEmail(campaignId: string, emailNumber: 1 | 2 | 3 | 4): Promise<boolean> {\n    try {\n      // Get campaign details\n      const campaign = await db.query.referralNurtureCampaigns.findFirst({\n        where: eq(referralNurtureCampaigns.id, campaignId),\n      });\n\n      if (!campaign) {\n        console.error(`[Referral Nurture] Campaign ${campaignId} not found`);\n        return false;\n      }\n\n      // Check if campaign is paused\n      if (campaign.status === 'paused') {\n        console.log(`[Referral Nurture] Campaign ${campaignId} is paused (${campaign.pauseReason})`);\n        return false;\n      }\n\n      const settings = await this.getEmailSettings();\n\n      // Check suppression list FIRST (hard bounces, spam complaints)\n      const { emailSuppressionList } = await import('@shared/schema');\n      const suppressed = await db.query.emailSuppressionList.findFirst({\n        where: eq(emailSuppressionList.email, campaign.customerEmail),\n      });\n      \n      if (suppressed) {\n        console.log(`[Referral Nurture] Email ${campaign.customerEmail} is suppressed (${suppressed.reason}), pausing campaign`);\n        await db\n          .update(referralNurtureCampaigns)\n          .set({\n            status: 'paused',\n            pausedAt: new Date(),\n            pauseReason: suppressed.reason,\n          })\n          .where(eq(referralNurtureCampaigns.id, campaignId));\n        return false;\n      }\n\n      // Check email preferences before sending\n      const { canSendEmail, addUnsubscribeFooter, addUnsubscribeFooterPlainText } = await import('./emailPreferenceEnforcer');\n      const prefCheck = await canSendEmail(campaign.customerEmail, { type: 'referral' });\n\n      if (!prefCheck.canSend) {\n        console.log(`[Referral Nurture] Skipping email - ${prefCheck.reason}`);\n\n        // Pause campaign\n        await db\n          .update(referralNurtureCampaigns)\n          .set({\n            status: 'paused',\n            pausedAt: new Date(),\n            pauseReason: 'opted_out',\n          })\n          .where(eq(referralNurtureCampaigns.id, campaignId));\n\n        return false;\n      }\n\n      // Get email content\n      const emailContent = await this.getEmailContent(\n        emailNumber,\n        {\n          id: campaign.customerId,\n          customerName: '',\n          customerEmail: campaign.customerEmail,\n        },\n        settings\n      );\n\n      // Send email via Resend\n      if (!process.env.RESEND_API_KEY) {\n        console.error('[Referral Nurture] RESEND_API_KEY not configured');\n        return false;\n      }\n\n      const resend = new Resend(process.env.RESEND_API_KEY);\n\n      // Add unsubscribe footer to email content\n      const htmlWithFooter = addUnsubscribeFooter(emailContent.htmlContent, prefCheck.unsubscribeUrl!);\n      const plainWithFooter = addUnsubscribeFooterPlainText(emailContent.plainTextContent, prefCheck.unsubscribeUrl!);\n\n      console.log(`[Referral Nurture] Sending email ${emailNumber} to ${campaign.customerEmail}`);\n\n      const emailResult = await resend.emails.send({\n        from: 'Economy Plumbing Services <reviews@economyplumbing.com>',\n        to: campaign.customerEmail,\n        subject: emailContent.subject,\n        html: htmlWithFooter,\n        text: plainWithFooter,\n        headers: {\n          'List-Unsubscribe': prefCheck.listUnsubscribeHeader!,\n          'List-Unsubscribe-Post': 'List-Unsubscribe=One-Click',\n        },\n      });\n\n      if (emailResult.error) {\n        console.error(`[Referral Nurture] Resend error:`, emailResult.error);\n        return false;\n      }\n\n      console.log(`[Referral Nurture] Email sent successfully. Resend ID: ${emailResult.data?.id}`);\n\n      // Create emailSendLog record for engagement tracking\n      await db.insert(emailSendLog).values({\n        campaignType: 'referral_nurture',\n        campaignRecordId: campaignId,\n        emailNumber,\n        recipientEmail: campaign.customerEmail,\n        recipientName: '',\n        customerId: campaign.customerId,\n        resendEmailId: emailResult.data?.id || null,\n        resendStatus: 'sent',\n      });\n\n      // Update campaign with email sent timestamp\n      const updateFields: any = {};\n\n      // Increment consecutive unopened (will be reset to 0 by webhook if they open)\n      updateFields.consecutiveUnopened = campaign.consecutiveUnopened + 1;\n\n      // Set specific email timestamp and status\n      if (emailNumber === 1) {\n        updateFields.email1SentAt = new Date();\n        updateFields.status = 'email1_sent';\n      }\n      if (emailNumber === 2) {\n        updateFields.email2SentAt = new Date();\n        updateFields.status = 'email2_sent';\n      }\n      if (emailNumber === 3) {\n        updateFields.email3SentAt = new Date();\n        updateFields.status = 'email3_sent';\n      }\n      if (emailNumber === 4) {\n        updateFields.email4SentAt = new Date();\n        updateFields.status = 'completed';\n        updateFields.completedAt = new Date();\n      }\n\n      // Auto-pause if 2 consecutive unopened emails\n      if (updateFields.consecutiveUnopened >= 2) {\n        updateFields.status = 'paused';\n        updateFields.pausedAt = new Date();\n        updateFields.pauseReason = 'low_engagement';\n        console.log(`[Referral Nurture] Auto-pausing campaign ${campaignId} due to 2 consecutive unopened emails`);\n      }\n\n      await db\n        .update(referralNurtureCampaigns)\n        .set(updateFields)\n        .where(eq(referralNurtureCampaigns.id, campaignId));\n\n      console.log(`[Referral Nurture] Successfully sent email ${emailNumber} for campaign ${campaignId}`);\n      return true;\n    } catch (error) {\n      console.error(`[Referral Nurture] Error sending email ${emailNumber} for campaign ${campaignId}:`, error);\n      return false;\n    }\n  }\n\n  /**\n   * Process pending referral nurture emails\n   */\n  async processPendingEmails() {\n    try {\n      const { allowed, reason } = await this.canSendEmails();\n      if (!allowed) {\n        console.log(`[Referral Nurture] Skipping email sends: ${reason}`);\n        return;\n      }\n\n      const now = new Date();\n\n      // Find active campaigns that need emails sent\n      const pendingCampaigns = await db\n        .select()\n        .from(referralNurtureCampaigns)\n        .where(\n          and(\n            or(\n              eq(referralNurtureCampaigns.status, 'queued'),\n              eq(referralNurtureCampaigns.status, 'email1_sent'),\n              eq(referralNurtureCampaigns.status, 'email2_sent'),\n              eq(referralNurtureCampaigns.status, 'email3_sent')\n            ),\n            lt(referralNurtureCampaigns.consecutiveUnopened, 2)\n          )\n        );\n\n      console.log(`[Referral Nurture] Found ${pendingCampaigns.length} active campaigns`);\n\n      for (const campaign of pendingCampaigns) {\n        const daysSinceCreation = Math.floor(\n          (now.getTime() - campaign.createdAt.getTime()) / (1000 * 60 * 60 * 24)\n        );\n\n        // Determine which email to send based on days since campaign creation\n        let emailToSend: 1 | 2 | 3 | 4 | null = null;\n\n        if (daysSinceCreation >= 14 && !campaign.email1SentAt) {\n          emailToSend = 1;\n        } else if (daysSinceCreation >= 60 && !campaign.email2SentAt) {\n          emailToSend = 2;\n        } else if (daysSinceCreation >= 150 && !campaign.email3SentAt) {\n          emailToSend = 3;\n        } else if (daysSinceCreation >= 210 && !campaign.email4SentAt) {\n          emailToSend = 4;\n        }\n\n        if (emailToSend) {\n          console.log(`[Referral Nurture] Sending email ${emailToSend} for campaign ${campaign.id} (${daysSinceCreation} days since creation)`);\n          await this.sendReferralEmail(campaign.id, emailToSend);\n        }\n      }\n    } catch (error) {\n      console.error(\"[Referral Nurture] Error processing pending emails:\", error);\n    }\n  }\n}\n\n// Export getter function for singleton instance\nlet instance: ReferralNurtureScheduler | null = null;\n\nexport function getReferralNurtureScheduler(): ReferralNurtureScheduler {\n  if (!instance) {\n    instance = new ReferralNurtureScheduler();\n  }\n  return instance;\n}\n","/**\n * AI Email Generator\n * \n * Generates personalized review request and referral nurture emails using OpenAI GPT-4o.\n * Features:\n * - Job-specific personalization (service type, amount, date)\n * - Seasonal awareness (winter freeze warnings, summer heat, etc.)\n * - Campaign stage optimization (urgency increases over drip sequence)\n * - Multiple messaging strategies (value, trust, urgency, social proof)\n * - Phone number integration for tracking\n */\n\nimport OpenAI from 'openai';\n\nconst openai = new OpenAI({\n  apiKey: process.env.OPENAI_API_KEY,\n});\n\ninterface JobDetails {\n  customerId: number;\n  customerName: string;\n  serviceType?: string;\n  jobAmount?: number;\n  jobDate?: Date;\n  location?: string;\n}\n\ninterface GenerateEmailOptions {\n  campaignType: 'review_request' | 'referral_nurture' | 'quote_followup';\n  emailNumber: 1 | 2 | 3 | 4; // Which email in the drip sequence\n  jobDetails: JobDetails;\n  phoneNumber?: string;\n  referralLink?: string; // Full referral link (e.g., \"https://plumbersthatcare.com/ref/JOHN-SMITH\")\n  strategy?: 'value' | 'trust' | 'urgency' | 'social_proof' | 'seasonal';\n}\n\ninterface GeneratedEmail {\n  subject: string;\n  preheader: string;\n  bodyHtml: string;\n  bodyPlain: string;\n  strategy: string;\n  seasonalContext?: string;\n}\n\n/**\n * Get current season and relevant messaging context\n */\nfunction getSeasonalContext(): { season: string; context: string } {\n  const month = new Date().getMonth(); // 0-11\n  \n  if (month >= 11 || month <= 1) {\n    // December, January, February\n    return {\n      season: 'winter',\n      context: 'Winter freeze protection is critical in Texas. Mention protecting pipes, water heater maintenance before cold snaps, and emergency service availability.'\n    };\n  } else if (month >= 2 && month <= 4) {\n    // March, April, May\n    return {\n      season: 'spring',\n      context: 'Spring is the perfect time for plumbing maintenance. Mention checking for winter damage, preparing for summer heat, and scheduling annual inspections.'\n    };\n  } else if (month >= 5 && month <= 7) {\n    // June, July, August\n    return {\n      season: 'summer',\n      context: 'Summer heat stresses plumbing systems. Mention water heater efficiency, increased water usage, A/C condensate line maintenance, and irrigation system checks.'\n    };\n  } else {\n    // September, October, November\n    return {\n      season: 'fall',\n      context: 'Fall is ideal for preparing plumbing for winter. Mention water heater inspections before winter, outdoor faucet winterization, and scheduling service before holidays.'\n    };\n  }\n}\n\n/**\n * Get messaging strategy for specific email number in sequence\n */\nfunction getEmailStrategy(campaignType: 'review_request' | 'referral_nurture' | 'quote_followup', emailNumber: number, customStrategy?: string): string {\n  if (customStrategy) return customStrategy;\n  \n  if (campaignType === 'review_request') {\n    // Review Request Drip (21 days)\n    const strategies = {\n      1: 'value', // Day 1: Thank you + easy review process\n      2: 'trust', // Day 7: We value your feedback\n      3: 'social_proof', // Day 14: Others are sharing experiences\n      4: 'urgency', // Day 21: Final gentle reminder\n    };\n    return strategies[emailNumber as keyof typeof strategies] || 'value';\n  } else if (campaignType === 'referral_nurture') {\n    // Referral Nurture (6 months)\n    const strategies = {\n      1: 'value', // Day 14: Introduce referral program + $25 reward\n      2: 'trust', // Day 60: Your friends deserve quality service\n      3: 'social_proof', // Day 150: Share success stories from referrals\n      4: 'urgency', // Day 210: Limited time to earn rewards (soft close)\n    };\n    return strategies[emailNumber as keyof typeof strategies] || 'value';\n  } else {\n    // Quote Follow-up (21 days) - nurture potential customers\n    const strategies = {\n      1: 'value', // Day 1: Thank you for considering us\n      2: 'trust', // Day 7: We're here when you're ready\n      3: 'seasonal', // Day 14: Timely service reminders\n      4: 'urgency', // Day 21: Limited-time offer or seasonal urgency\n    };\n    return strategies[emailNumber as keyof typeof strategies] || 'value';\n  }\n}\n\n/**\n * Generate personalized email content using AI\n */\nexport async function generateEmail(options: GenerateEmailOptions): Promise<GeneratedEmail> {\n  const { campaignType, emailNumber, jobDetails, phoneNumber, referralLink, strategy: customStrategy } = options;\n  const { season, context: seasonalContext } = getSeasonalContext();\n  const strategy = getEmailStrategy(campaignType, emailNumber, customStrategy);\n\n  // Build the AI prompt\n  const emailSequence = `Email ${emailNumber} of 4`;\n  const daysFromJob = campaignType === 'referral_nurture'\n    ? [14, 60, 150, 210][emailNumber - 1]\n    : [1, 7, 14, 21][emailNumber - 1]; // review_request and quote_followup use same timing\n\n  const systemPrompt = `You are an expert email copywriter for Economy Plumbing Services, a family-owned plumbing company serving Austin and Central Texas.\n\nBrand Voice:\n- Friendly, professional, and trustworthy\n- Texas-local feel (but not overly \"y'all\")\n- Focus on quality service and customer relationships\n- Value honesty and transparency\n- Family-owned business for 20+ years\n\nCRITICAL: Template Generation Rules:\n- You are creating TEMPLATES with merge fields, not personalized emails\n- Use merge field syntax: {{customerName}}, {{serviceType}}, {{jobAmount}}, {{location}}\n- NEVER use hardcoded names like \"John\" or \"Sarah\"\n- DO NOT include seasonal content (fall, winter, summer, etc.) - that will be added dynamically at send-time\n- DO NOT reference specific job details - use merge fields instead\n- Templates should be evergreen and work year-round\n- The admin will approve the template structure/tone, then AI will personalize for each customer at send-time\n- Available merge fields: {{customerName}}, {{serviceType}}, {{jobAmount}}, {{location}}, {{jobDate}}\n\nEmail Guidelines:\n- Keep subject lines under 50 characters, compelling and personal\n- Preheader should complement subject (40-80 chars)\n- Use HTML formatting with proper structure\n- Include clear call-to-action buttons\n- Mobile-friendly layout\n- Use merge fields for personalization ({{customerName}}, {{serviceType}}, etc.)\n- ${phoneNumber ? `Include phone number ${phoneNumber} for tracking` : 'No phone number tracking'}`;\n\n  let userPrompt = '';\n  \n  if (campaignType === 'review_request') {\n    userPrompt = `\nGenerate a review request email with these specifications:\n\nCampaign Details:\n- Type: Review Request Drip Campaign\n- ${emailSequence} in sequence (sent ${daysFromJob} days after service completion)\n- Strategy: ${strategy}\n- NOTE: Do NOT include seasonal context in template - it will be added dynamically when sending\n\nTemplate Context (use merge fields, not actual values):\n- Example Customer Name: ${jobDetails.customerName} → Use {{customerName}} in template\n- Example Service: ${jobDetails.serviceType || 'plumbing service'} → Use {{serviceType}} in template\n- Example Job Amount: ${jobDetails.jobAmount ? `$${(jobDetails.jobAmount / 100).toFixed(2)}` : 'varies'} → Use {{jobAmount}} in template\n- Example Location: ${jobDetails.location || 'Central Texas'} → Use {{location}} in template\n\nIMPORTANT: Create a TEMPLATE using {{merge_fields}}, not a personalized email with hardcoded values!\n\nEmail Objectives:\n${emailNumber === 1 ? `\n- Thank customer for choosing Economy Plumbing\n- Emphasize quality of service provided\n- Make leaving a review EASY (mention Google, Facebook, direct links)\n- Light ask, not pushy\n` : emailNumber === 2 ? `\n- Gentle reminder about review request\n- Emphasize how feedback helps improve service\n- Show appreciation for their business\n- Mention we're always here if they need anything\n` : emailNumber === 3 ? `\n- Social proof: mention that other customers love sharing experiences\n- Explain how reviews help local families find great plumbers\n- Still friendly, slightly more direct\n- Offer to address any concerns if they haven't reviewed\n` : `\n- Final gentle reminder\n- Express that we'd love to hear their feedback\n- Last chance framing (but warm, not desperate)\n- Thank them regardless of whether they review\n`}\n\n${phoneNumber ? `IMPORTANT: Include the phone number ${phoneNumber} in the email signature for tracking purposes. Format: \"Questions? Call us at ${phoneNumber}\"` : ''}\n\nInclude a clear CTA button with text like \"Leave a Review\" that links to: https://plumbersthatcare.com/leave-review\n\nCRITICAL UTM TRACKING REQUIREMENT:\nALL links in the email MUST include UTM parameters for attribution tracking:\n- utm_source=review_request_email\n- utm_medium=email\n- utm_campaign=review_drip_email_${emailNumber}\n\nExample: https://plumbersthatcare.com/leave-review?utm_source=review_request_email&utm_medium=email&utm_campaign=review_drip_email_${emailNumber}\n\nApply these UTM parameters to ALL website links in the email (buttons, text links, footer links, etc.).\n\nGenerate:\n1. Subject line (under 50 chars, ${strategy} focused)\n2. Preheader text (40-80 chars)\n3. HTML email body (well-formatted, professional, mobile-friendly)\n4. Plain text version (clean, readable)\n\nReturn as JSON:\n{\n  \"subject\": \"...\",\n  \"preheader\": \"...\",\n  \"bodyHtml\": \"...\",\n  \"bodyPlain\": \"...\"\n}\n`;\n  } else if (campaignType === 'referral_nurture') {\n    userPrompt = `\nGenerate a referral nurture email with these specifications:\n\nCampaign Details:\n- Type: Referral Nurture Campaign\n- ${emailSequence} in sequence (sent ${daysFromJob} days after positive review)\n- Strategy: ${strategy}\n- NOTE: Do NOT include seasonal context in template - it will be added dynamically when sending\n\nTemplate Context (use merge fields, not actual values):\n- Example Customer Name: ${jobDetails.customerName} → Use {{customerName}} in template\n- Example Service: ${jobDetails.serviceType || 'plumbing service'} → Use {{serviceType}} in template\n- Example Location: ${jobDetails.location || 'Central Texas'} → Use {{location}} in template\n\nIMPORTANT: Create a TEMPLATE using {{merge_fields}}, not a personalized email with hardcoded values!\n\nReferral Program Details:\n- Referrer earns $25 account credit for each successful referral\n- Referee gets quality service from trusted local plumber\n- Simple process: share unique link or referral code\n\nEmail Objectives:\n${emailNumber === 1 ? `\n- Introduce referral program (they left positive review, so they're happy!)\n- Explain $25 credit reward per referral\n- Make it EASY to share (unique link, simple process)\n- Focus on helping friends/family find great plumber\n- Mention referral link available in customer portal\n` : emailNumber === 2 ? `\n- Gentle reminder about referral program\n- Emphasize helping friends/neighbors\n- Share that they're earning rewards for referrals\n- Maybe include a mini success story\n- Reinforce trust and quality service\n` : emailNumber === 3 ? `\n- Social proof: mention how many customers have referred friends\n- Success stories from referral program\n- Emphasize community benefit (helping local families)\n- Reminder of $25 per referral reward\n` : `\n- Final touch: opportunity still available\n- Soft close with appreciation\n- Thank them for being valued customer\n- Leave door open for future referrals\n- No pressure, just gratitude\n`}\n\n${phoneNumber ? `IMPORTANT: Include the phone number ${phoneNumber} in the email signature for tracking purposes. Format: \"Questions? Call us at ${phoneNumber}\"` : ''}\n\n${referralLink ? `CRITICAL: Include their unique referral link in the email: ${referralLink}\n\nInstructions for including the referral link:\n- Prominently display their referral link: ${referralLink}\n- Explain they can share this link with friends, family, and neighbors\n- When someone books service through their link, they earn $25 credit\n- Make the link easy to copy and share (formatted as clickable button and also plain text)\n- Include a clear CTA button that links to: ${referralLink}` : `CRITICAL: Tell them to visit https://plumbersthatcare.com/customer-portal to get their personalized referral link. Include a CTA button that links to: https://plumbersthatcare.com/customer-portal`}\n\nCRITICAL UTM TRACKING REQUIREMENT:\nALL links to plumbersthatcare.com in the email MUST include UTM parameters for attribution tracking:\n- utm_source=referral_nurture_email\n- utm_medium=email\n- utm_campaign=referral_drip_email_${emailNumber}\n\nExample for customer portal link: https://plumbersthatcare.com/customer-portal?utm_source=referral_nurture_email&utm_medium=email&utm_campaign=referral_drip_email_${emailNumber}\n\nApply these UTM parameters to ALL plumbersthatcare.com links (buttons, text links, footer links, etc.).\nNOTE: Do NOT add UTM parameters to the unique referral link ${referralLink || ''} - only to regular website links.\n\nGenerate:\n1. Subject line (under 50 chars, ${strategy} focused)\n2. Preheader text (40-80 chars)\n3. HTML email body (well-formatted, professional, mobile-friendly, includes referral link instructions)\n4. Plain text version (clean, readable)\n\nReturn as JSON:\n{\n  \"subject\": \"...\",\n  \"preheader\": \"...\",\n  \"bodyHtml\": \"...\",\n  \"bodyPlain\": \"...\"\n}\n`;\n  } else {\n    // quote_followup campaign\n    userPrompt = `\nGenerate a quote follow-up email with these specifications:\n\nCampaign Details:\n- Type: Quote Follow-up Campaign (for customers who received estimate but no work completed)\n- ${emailSequence} in sequence (sent ${daysFromJob} days after quote/estimate)\n- Strategy: ${strategy}\n- NOTE: Do NOT include seasonal context in template - it will be added dynamically when sending\n\nTemplate Context (use merge fields, not actual values):\n- Example Customer Name: ${jobDetails.customerName} → Use {{customerName}} in template\n- Example Service: ${jobDetails.serviceType || 'plumbing service'} → Use {{serviceType}} in template\n- Example Location: ${jobDetails.location || 'Central Texas'} → Use {{location}} in template\n\nIMPORTANT: Create a TEMPLATE using {{merge_fields}}, not a personalized email with hardcoded values!\n\nImportant Context:\n- This customer received a quote/estimate but NO WORK WAS DONE (invoice was $0)\n- We want to stay top-of-mind for when they're ready to move forward\n- Focus on nurturing the relationship, not pressuring them\n- If they appreciated our professionalism during the estimate, that's worth mentioning\n\nEmail Objectives:\n${emailNumber === 1 ? `\n- Thank them for considering Economy Plumbing\n- Acknowledge that they received a quote but haven't moved forward yet\n- Let them know we're here when they're ready\n- Soft ask: if they appreciated our professionalism during the quote, we'd love to hear about it\n- NO PRESSURE - just staying in touch\n` : emailNumber === 2 ? `\n- Gentle check-in: \"Just following up on your estimate\"\n- Offer help: \"Do you have any questions about the quote?\"\n- Reinforce our value: quality work, fair pricing, family-owned\n- Mention we're always here to help, even with questions\n- Build trust and stay top-of-mind\n` : emailNumber === 3 ? `\n- Seasonal reminder: ${seasonalContext}\n- Timely service recommendation based on season\n- Educational value: why this service matters now\n- Still warm and helpful, not salesy\n- \"When you're ready, we're here\"\n` : `\n- Final soft touch: limited-time seasonal offer or discount (if appropriate)\n- Express appreciation for their consideration\n- Leave door open: \"We hope to earn your business in the future\"\n- Include testimonial or social proof\n- Thank them regardless of whether they book\n`}\n\n${phoneNumber ? `IMPORTANT: Include the phone number ${phoneNumber} in the email signature for tracking purposes. Format: \"Questions? Call us at ${phoneNumber}\"` : ''}\n\nInclude a clear CTA button with text like \"Get a Quote\" or \"Schedule Service\" that links to: https://plumbersthatcare.com/contact\n\nCRITICAL UTM TRACKING REQUIREMENT:\nALL links in the email MUST include UTM parameters for attribution tracking:\n- utm_source=quote_followup_email\n- utm_medium=email\n- utm_campaign=quote_followup_drip_email_${emailNumber}\n\nExample: https://plumbersthatcare.com/contact?utm_source=quote_followup_email&utm_medium=email&utm_campaign=quote_followup_drip_email_${emailNumber}\n\nApply these UTM parameters to ALL website links in the email (buttons, text links, footer links, etc.).\n\nGenerate:\n1. Subject line (under 50 chars, ${strategy} focused, NOT pushy)\n2. Preheader text (40-80 chars)\n3. HTML email body (well-formatted, professional, mobile-friendly)\n4. Plain text version (clean, readable)\n\nReturn as JSON:\n{\n  \"subject\": \"...\",\n  \"preheader\": \"...\",\n  \"bodyHtml\": \"...\",\n  \"bodyPlain\": \"...\"\n}\n`;\n  }\n\n  try {\n    const completion = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt }\n      ],\n      response_format: { type: \"json_object\" },\n      temperature: 0.7,\n    });\n\n    const content = completion.choices[0]?.message?.content;\n    if (!content) {\n      throw new Error('No content generated from AI');\n    }\n\n    const parsed = JSON.parse(content);\n    \n    return {\n      subject: parsed.subject,\n      preheader: parsed.preheader,\n      bodyHtml: parsed.bodyHtml,\n      bodyPlain: parsed.bodyPlain,\n      strategy,\n      seasonalContext: `${season}: ${seasonalContext}`\n    };\n  } catch (error: any) {\n    console.error('[AI Email Generator] Error:', error);\n    throw new Error(`Failed to generate email: ${error.message}`);\n  }\n}\n\n/**\n * Regenerate email with different strategy or emphasis\n */\nexport async function regenerateEmail(\n  previousEmail: GeneratedEmail,\n  options: GenerateEmailOptions,\n  feedback: string\n): Promise<GeneratedEmail> {\n  // Call generate with modified prompt including feedback\n  const regenerateOptions = {\n    ...options,\n    // Could add feedback to the prompt here\n  };\n  \n  return await generateEmail(regenerateOptions);\n}\n\n/**\n * Generate referee welcome email\n * Sent immediately when someone is referred to Economy Plumbing\n */\nexport async function generateRefereeWelcomeEmail(options: {\n  refereeName: string;\n  referrerName: string;\n  phoneNumber?: string;\n}): Promise<{ subject: string; bodyHtml: string; bodyPlain: string }> {\n  const { refereeName, referrerName, phoneNumber } = options;\n  const { season, context: seasonalContext } = getSeasonalContext();\n\n  const systemPrompt = `You are an expert email copywriter for Economy Plumbing Services, a family-owned plumbing company serving Austin and Central Texas.\n\nBrand Voice:\n- Friendly, professional, and trustworthy\n- Texas-local feel (but not overly \"y'all\")\n- Focus on quality service and customer relationships\n- Value honesty and transparency\n- Family-owned business for 20+ years\n\nEmail Guidelines:\n- Keep subject lines under 50 characters, compelling and personal\n- Use HTML formatting with proper structure\n- Include clear call-to-action buttons\n- Mobile-friendly layout\n- Warm welcome tone - they were referred by a friend\n- ${phoneNumber ? `Include phone number ${phoneNumber} for tracking` : 'No phone number tracking'}`;\n\n  const userPrompt = `Generate a welcome email for a new referee with these specifications:\n\nCampaign Details:\n- Type: Referee Welcome Email\n- Sent immediately when someone is referred to Economy Plumbing\n- Purpose: Warm introduction and make booking easy\n- Season: ${season}\n- Seasonal Context: ${seasonalContext}\n\nRecipient Details:\n- Name: ${refereeName}\n- Referred by: ${referrerName} (their friend/family member)\n\nEmail Objectives:\n- Thank them for trusting the referral from ${referrerName}\n- Welcome them to the Economy Plumbing family\n- Emphasize personal touch: friend recommended us, we'll take great care of them\n- Make scheduling service EASY (include phone number and online scheduler link)\n- Brief mention of services: water heaters, drain cleaning, leak repair, emergency service\n- Mention 20+ years serving Central Texas families\n- Professional but warm tone - this is a friend-to-friend referral\n\n${phoneNumber ? `IMPORTANT: Include the phone number ${phoneNumber} in the email for tracking purposes. Format: \"Ready to schedule? Call us at ${phoneNumber}\"` : ''}\n\nInclude a clear CTA button with text like \"Schedule Service Now\" that links to: https://plumbersthatcare.com/schedule\n\n${seasonalContext ? `Seasonal touch: ${seasonalContext}` : ''}\n\nGenerate:\n1. Subject line (under 50 chars, friendly and welcoming)\n2. HTML email body (well-formatted, professional, mobile-friendly)\n3. Plain text version (clean, readable)\n\nReturn as JSON:\n{\n  \"subject\": \"...\",\n  \"bodyHtml\": \"...\",\n  \"bodyPlain\": \"...\"\n}`;\n\n  try {\n    const completion = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt }\n      ],\n      response_format: { type: \"json_object\" },\n      temperature: 0.7,\n    });\n\n    const content = completion.choices[0]?.message?.content;\n    if (!content) {\n      throw new Error('No content generated from AI');\n    }\n\n    const parsed = JSON.parse(content);\n    \n    return {\n      subject: parsed.subject,\n      bodyHtml: parsed.bodyHtml,\n      bodyPlain: parsed.bodyPlain,\n    };\n  } catch (error: any) {\n    console.error('[AI Email Generator] Error generating referee welcome email:', error);\n    throw new Error(`Failed to generate referee welcome email: ${error.message}`);\n  }\n}\n\n/**\n * Personalize an email template for a specific customer\n * This function takes a template with merge fields and job data, then uses AI to:\n * 1. Replace merge fields with actual customer data\n * 2. Analyze the job details to add personalized touches\n * 3. Generate context-aware content based on the specific work done\n */\nexport async function personalizeEmailForCustomer(options: {\n  template: {\n    subject: string;\n    htmlContent: string;\n    plainTextContent: string | null;\n    preheader?: string | null;\n  };\n  jobData: {\n    customerName: string;\n    serviceType?: string;\n    jobAmount?: number;\n    jobDate?: Date;\n    location?: string;\n    jobDescription?: string;\n    estimateDetails?: string;\n    workCompleted?: string;\n    customerHistory?: Array<{\n      date: Date;\n      service: string;\n      amount: number;\n      notes?: string;\n    }>;\n    totalJobsCompleted?: number;\n    isRepeatCustomer?: boolean;\n  };\n  campaignType: 'review_request' | 'referral_nurture' | 'quote_followup';\n  phoneNumber?: string;\n  referralLink?: string;\n}): Promise<{ subject: string; preheader: string; bodyHtml: string; bodyPlain: string }> {\n  const { template, jobData, campaignType, phoneNumber, referralLink } = options;\n  const { season, context: seasonalContext } = getSeasonalContext();\n\n  const systemPrompt = `You are an expert email personalizer for Economy Plumbing Services.\n\nYour task is to take an approved email TEMPLATE and personalize it for a specific customer using their real job data, history, and current seasonal context.\n\nCRITICAL RULES:\n1. Keep the overall structure, tone, and CTAs from the template\n2. Replace merge fields ({{customerName}}, {{serviceType}}, etc.) with actual data\n3. Add personalized touches based on the specific work done AND customer history\n4. Analyze job details AND past jobs to make references feel genuine and specific\n5. Add seasonal context relevant to RIGHT NOW (${season})\n6. Generate a compelling, personalized preheader text (40-80 chars)\n7. Maintain the professional, friendly brand voice\n8. DO NOT change URLs, phone numbers, or key messaging from the template\n9. The admin approved the template structure - respect it\n\nCurrent Season & Context:\n- Season: ${season}\n- Seasonal Context: ${seasonalContext}\n- Use this to add timely, relevant seasonal messaging\n\nCustomer Information:\n- Name: ${jobData.customerName}\n- Location: ${jobData.location || 'Central Texas'}\n${jobData.isRepeatCustomer ? `- REPEAT CUSTOMER (${jobData.totalJobsCompleted || 'multiple'} jobs completed)` : '- First-time customer'}\n\nCurrent Job/Estimate:\n- Service Type: ${jobData.serviceType || 'plumbing service'}\n- Job Amount: ${jobData.jobAmount ? `$${(jobData.jobAmount / 100).toFixed(2)}` : 'N/A'}\n- Job Date: ${jobData.jobDate ? jobData.jobDate.toLocaleDateString() : 'recent'}\n${jobData.jobDescription ? `- Job Description: ${jobData.jobDescription}` : ''}\n${jobData.estimateDetails ? `- Estimate Details: ${jobData.estimateDetails}` : ''}\n${jobData.workCompleted ? `- Work Completed: ${jobData.workCompleted}` : ''}\n\n${jobData.customerHistory && jobData.customerHistory.length > 0 ? `\nCustomer History (Previous Jobs):\n${jobData.customerHistory.map((job, i) => \n  `${i + 1}. ${job.date.toLocaleDateString()}: ${job.service} ($${(job.amount / 100).toFixed(2)})${job.notes ? ` - ${job.notes}` : ''}`\n).join('\\n')}\n\nIMPORTANT: Reference their history to build rapport and show you remember them!\n` : 'No previous job history - this is their first interaction with us'}\n\nCampaign Type: ${campaignType}`;\n\n  const userPrompt = `Personalize this email template for ${jobData.customerName}:\n\nTEMPLATE SUBJECT: ${template.subject}\nTEMPLATE PREHEADER: ${template.preheader || 'Generate one based on content'}\n\nTEMPLATE HTML BODY:\n${template.htmlContent}\n\nTEMPLATE PLAIN TEXT:\n${template.plainTextContent || 'N/A'}\n\nInstructions:\n1. Replace all merge fields with actual customer data:\n   - {{customerName}} → ${jobData.customerName}\n   - {{serviceType}} → ${jobData.serviceType || 'plumbing service'}\n   - {{jobAmount}} → ${jobData.jobAmount ? `$${(jobData.jobAmount / 100).toFixed(2)}` : 'varies'}\n   - {{location}} → ${jobData.location || 'Central Texas'}\n   - {{jobDate}} → ${jobData.jobDate ? jobData.jobDate.toLocaleDateString() : 'recently'}\n\n2. Add SEASONAL CONTEXT based on current season (${season}):\n   - Reference seasonal plumbing needs: ${seasonalContext}\n   - Make it feel timely and relevant to RIGHT NOW\n   - This is WHY templates don't have seasonal content - you add it dynamically!\n\n3. Analyze customer history and job details for personalization:\n   ${jobData.isRepeatCustomer ? '- Acknowledge they\\'re a valued repeat customer' : '- Welcome them as a new customer'}\n   ${jobData.customerHistory && jobData.customerHistory.length > 0 ? `- Reference their previous work (e.g., \"last year's water heater installation\")` : ''}\n   ${jobData.jobDescription ? `- Reference the specific work: ${jobData.jobDescription}` : ''}\n   ${jobData.estimateDetails ? `- Mention estimate details naturally: ${jobData.estimateDetails}` : ''}\n   ${jobData.workCompleted ? `- Acknowledge completed work: ${jobData.workCompleted}` : ''}\n\n4. Generate a compelling PREHEADER TEXT (40-80 chars):\n   - Personalized for this specific customer\n   - Complements the subject line\n   - Creates curiosity or urgency\n\n5. Keep the template structure, CTAs, and brand voice\n6. Make it feel like it was written specifically for THIS customer, RIGHT NOW\n7. ${phoneNumber ? `Ensure phone number ${phoneNumber} is included for tracking` : 'Use standard phone number'}\n8. ${referralLink ? `Include their unique referral link: ${referralLink}` : ''}\n\nReturn as JSON:\n{\n  \"subject\": \"...\",\n  \"preheader\": \"...\",\n  \"bodyHtml\": \"...\",\n  \"bodyPlain\": \"...\"\n}`;\n\n  try {\n    const completion = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt }\n      ],\n      response_format: { type: \"json_object\" },\n      temperature: 0.7,\n    });\n\n    const content = completion.choices[0]?.message?.content;\n    if (!content) {\n      throw new Error('No content generated from AI');\n    }\n\n    const parsed = JSON.parse(content);\n    \n    return {\n      subject: parsed.subject,\n      preheader: parsed.preheader,\n      bodyHtml: parsed.bodyHtml,\n      bodyPlain: parsed.bodyPlain,\n    };\n  } catch (error: any) {\n    console.error('[AI Email Personalizer] Error:', error);\n    throw new Error(`Failed to personalize email: ${error.message}`);\n  }\n}\n\n/**\n * Generate AI-powered thank you email for referrer (sent when they submit a referral)\n */\nexport async function generateReferrerThankYouEmail(\n  options: {\n    referrerName: string;\n    refereeName: string;\n    phoneNumber?: string;\n  },\n  customPrompt?: string,\n  brandGuidelines?: string\n): Promise<{ subject: string; bodyHtml: string; bodyPlain: string }> {\n  const { referrerName, refereeName, phoneNumber } = options;\n  const { season, context: seasonalContext } = getSeasonalContext();\n\n  const defaultSystemPrompt = `You are an AI email writer for Economy Plumbing Services, a trusted Austin-area plumbing company.\n\nYour task is to generate a warm, appreciative thank you email to a customer who just submitted a referral.\n\nCRITICAL RULES:\n1. Express genuine gratitude for the referral\n2. Explain the referral reward clearly ($25 credit per successful referral)\n3. Let them know what happens next (we'll reach out to their friend)\n4. Remind them they can refer multiple people\n5. Keep it short, warm, and personal (not salesy)\n6. Use Austin/Texas-friendly language\n7. Include clear contact info using the placeholder {{trackingNumber}} for phone number\n8. Make them feel valued and appreciated\n9. Professional but friendly tone\n10. Mobile-optimized HTML (works on all devices)\n11. IMPORTANT: Always use {{trackingNumber}} as the phone number placeholder - it will be replaced with the campaign-specific tracking number\n\nEmail Structure:\n- Subject line: Personal, grateful, clear benefit mentioned\n- Opening: Thank them by name for the specific referral\n- Body: Explain next steps, reward details, encourage more referrals\n- Closing: Gratitude + easy way to contact us\n- Call to Action: Refer more friends (make it easy)\n\nBrand Voice:\n- Friendly, trustworthy, professional\n- Austin/Central Texas local feel\n- Family-owned business vibe\n- Helpful and approachable\n- No pushy sales language\n\nSeasonal Context (${season}):\n${seasonalContext}\n- Use this to add a timely seasonal touch if relevant\n\n${brandGuidelines ? `\\nADDITIONAL BRAND GUIDELINES:\\n${brandGuidelines}` : ''}\n${customPrompt ? `\\nCUSTOM INSTRUCTIONS:\\n${customPrompt}` : ''}`;\n\n  const systemPrompt = defaultSystemPrompt;\n\n  const userPrompt = `Generate a thank you email for ${referrerName} who just referred ${refereeName}.\n\nKey Details:\n- Referrer: ${referrerName}\n- Person they referred: ${refereeName}\n- Reward: $25 credit for each successful referral (when referred friend becomes a customer)\n- Phone: {{trackingNumber}} (use this exact placeholder - do not replace it)\n- Website: plumbersthatcare.com\n- Current Season: ${season}\n\nRequirements:\n1. Thank ${referrerName} personally for referring ${refereeName}\n2. Explain we'll reach out to ${refereeName} soon\n3. Clarify the reward: $25 credit after ${refereeName} becomes a customer\n4. Mention credits are valid for 1 year\n5. Encourage them to refer more friends (each one = another $25)\n6. Make them feel appreciated and valued\n7. Include clear contact information\n8. Add a subtle seasonal touch based on current season (${season})\n9. Keep it warm and personal, not corporate\n\nCRITICAL UTM TRACKING REQUIREMENT:\nALL links to plumbersthatcare.com in the email MUST include UTM parameters for attribution tracking:\n- utm_source=referral_thank_you_email\n- utm_medium=email\n- utm_campaign=referral_thankyou\n\nExample: https://plumbersthatcare.com/customer-portal?utm_source=referral_thank_you_email&utm_medium=email&utm_campaign=referral_thankyou\n\nApply these UTM parameters to ALL website links in the email (buttons, text links, footer links, etc.).\n\nReturn as JSON:\n{\n  \"subject\": \"Thank you for referring ${refereeName}!\",\n  \"bodyHtml\": \"Mobile-optimized HTML email\",\n  \"bodyPlain\": \"Plain text version\"\n}`;\n\n  try {\n    const completion = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt }\n      ],\n      response_format: { type: \"json_object\" },\n      temperature: 0.7,\n    });\n\n    const content = completion.choices[0]?.message?.content;\n    if (!content) {\n      throw new Error('No content generated from AI');\n    }\n\n    const parsed = JSON.parse(content);\n    \n    return {\n      subject: parsed.subject,\n      bodyHtml: parsed.bodyHtml,\n      bodyPlain: parsed.bodyPlain,\n    };\n  } catch (error: any) {\n    console.error('[AI Email Generator] Error generating referrer thank you email:', error);\n    throw new Error(`Failed to generate referrer thank you email: ${error.message}`);\n  }\n}\n\n/**\n * Generate AI-powered success notification for referrer (sent when referee completes first job)\n */\nexport async function generateReferrerSuccessEmail(\n  options: {\n    referrerName: string;\n    refereeName: string;\n    creditAmount: number; // In dollars (e.g., 25.00)\n    creditExpiresAt: Date;\n    currentBalance?: number; // Total available credits in dollars\n    phoneNumber?: string;\n  },\n  customPrompt?: string,\n  brandGuidelines?: string\n): Promise<{ subject: string; bodyHtml: string; bodyPlain: string }> {\n  const { referrerName, refereeName, creditAmount, creditExpiresAt, currentBalance, phoneNumber } = options;\n  const { season, context: seasonalContext } = getSeasonalContext();\n\n  const defaultSystemPrompt = `You are an AI email writer for Economy Plumbing Services, a trusted Austin-area plumbing company.\n\nYour task is to generate an exciting congratulatory email to a customer whose referral just converted (their friend became a customer).\n\nCRITICAL RULES:\n1. Lead with celebration - their referral succeeded!\n2. Clearly state the credit amount earned\n3. Show their total available credit balance if provided\n4. Explain credit expiration clearly\n5. Encourage them to refer more friends\n6. Make them feel successful and appreciated\n7. Include easy next steps (how to use credit, refer more)\n8. Professional but exciting tone\n9. Mobile-optimized HTML\n10. Create urgency to use credits before expiration\n11. IMPORTANT: Always use {{trackingNumber}} as the phone number placeholder - it will be replaced with the campaign-specific tracking number\n\nEmail Structure:\n- Subject: Exciting news, credit confirmed\n- Opening: Congratulate them on successful referral\n- Body: Credit details, total balance, expiration, encourage more referrals\n- Closing: How to use credits + easy referral process\n- Call to Action: Schedule service to use credit OR refer another friend\n\nBrand Voice:\n- Celebratory and positive\n- Austin/Central Texas local feel\n- Family-owned business vibe\n- Grateful for their support\n- Encouraging without being pushy\n\nSeasonal Context (${season}):\n${seasonalContext}\n- Use this to suggest seasonal services they could use their credit on\n\n${brandGuidelines ? `\\nADDITIONAL BRAND GUIDELINES:\\n${brandGuidelines}` : ''}\n${customPrompt ? `\\nCUSTOM INSTRUCTIONS:\\n${customPrompt}` : ''}`;\n\n  const systemPrompt = defaultSystemPrompt;\n\n  const userPrompt = `Generate a success notification for ${referrerName} - their referral (${refereeName}) just became a customer!\n\nKey Details:\n- Referrer: ${referrerName}\n- Successful referral: ${refereeName}\n- Credit earned: $${creditAmount.toFixed(2)}\n${currentBalance !== undefined ? `- Total available credits: $${currentBalance.toFixed(2)}` : ''}\n- Credit expires: ${creditExpiresAt.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}\n- Phone: {{trackingNumber}} (use this exact placeholder - do not replace it)\n- Website: plumbersthatcare.com\n- Current Season: ${season}\n\nRequirements:\n1. Congratulate ${referrerName} - ${refereeName} is now a customer!\n2. Clearly state they earned $${creditAmount.toFixed(2)} credit\n3. ${currentBalance !== undefined ? `Show total available balance: $${currentBalance.toFixed(2)}` : 'Mention this is their referral credit'}\n4. Explain credits expire on ${creditExpiresAt.toLocaleDateString()}\n5. Encourage them to:\n   a) Use their credit on upcoming service (suggest seasonal services based on ${season})\n   b) Refer more friends to earn more credits\n6. Make them feel successful and appreciated\n7. Include clear contact information\n8. Add seasonal context for services they could use credit on\n9. Create gentle urgency about credit expiration without being pushy\n10. Make referring more friends easy and appealing\n\nCRITICAL UTM TRACKING REQUIREMENT:\nALL links to plumbersthatcare.com in the email MUST include UTM parameters for attribution tracking:\n- utm_source=referral_success_email\n- utm_medium=email\n- utm_campaign=referral_success\n\nExample: https://plumbersthatcare.com/schedule?utm_source=referral_success_email&utm_medium=email&utm_campaign=referral_success\n\nApply these UTM parameters to ALL website links in the email (buttons, text links, footer links, etc.).\n\nTone: Celebratory, grateful, encouraging\n\nReturn as JSON:\n{\n  \"subject\": \"Great news! You earned $${creditAmount.toFixed(2)} in referral credit\",\n  \"bodyHtml\": \"Mobile-optimized HTML email\",\n  \"bodyPlain\": \"Plain text version\"\n}`;\n\n  try {\n    const completion = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt }\n      ],\n      response_format: { type: \"json_object\" },\n      temperature: 0.7,\n    });\n\n    const content = completion.choices[0]?.message?.content;\n    if (!content) {\n      throw new Error('No content generated from AI');\n    }\n\n    const parsed = JSON.parse(content);\n    \n    return {\n      subject: parsed.subject,\n      bodyHtml: parsed.bodyHtml,\n      bodyPlain: parsed.bodyPlain,\n    };\n  } catch (error: any) {\n    console.error('[AI Email Generator] Error generating referrer success email:', error);\n    throw new Error(`Failed to generate referrer success email: ${error.message}`);\n  }\n}\n"],"names":[],"mappings":"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"}