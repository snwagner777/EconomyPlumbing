module.exports=[902569,e=>{"use strict";var n=e.i(292309);let c=!1,o=Date.now();function t(){return c&&Date.now()-o>18e5&&(console.log("[ServiceTitan Sync] âš ï¸  Detected stale sync lock (no heartbeat for 30min), resetting..."),c=!1),c}function s(){console.log("[ServiceTitan Sync] ðŸ”“ Manually resetting sync lock..."),c=!1,o=Date.now()}function i(){o=Date.now()}async function r(){if(c)return void console.log("[ServiceTitan Sync] â­ï¸  Sync already in progress, skipping...");try{c=!0,console.log("[ServiceTitan Sync] Starting customer sync...");let e=(0,n.getServiceTitanAPI)(),o=await e.syncAllCustomers();console.log(`[ServiceTitan Sync] âœ… Customer sync completed!`),console.log(`[ServiceTitan Sync] - Customers synced: ${o.customersCount}`),console.log(`[ServiceTitan Sync] - Contacts synced: ${o.contactsCount}`),console.log(`[ServiceTitan Sync] - Duration: ${(o.duration/1e3).toFixed(1)}s`)}catch(e){console.error("[ServiceTitan Sync] âŒ Customer sync failed:",e)}finally{c=!1}}async function a(){if(c)return void console.log("[ServiceTitan Sync] â­ï¸  Sync already in progress, skipping...");try{c=!0;let e=Date.now();console.log("[ServiceTitan Sync] ðŸš€ Starting full data sync (customers + jobs)...");let o=(0,n.getServiceTitanAPI)();console.log("[ServiceTitan Sync] ðŸ“‹ Phase 1/2: Syncing customers..."),i();let t=await o.syncAllCustomers();console.log(`[ServiceTitan Sync] âœ… Customer sync completed!`),console.log(`[ServiceTitan Sync] - Customers synced: ${t.customersCount}`),console.log(`[ServiceTitan Sync] - Contacts synced: ${t.contactsCount}`),console.log(`[ServiceTitan Sync] - Customer sync duration: ${(t.duration/1e3).toFixed(1)}s`),console.log("[ServiceTitan Sync] ðŸ“‹ Phase 2/2: Syncing jobs..."),i();let s=await o.syncAllJobs();console.log(`[ServiceTitan Sync] âœ… Job sync completed!`),console.log(`[ServiceTitan Sync] - Jobs synced: ${s.jobsCount}`),console.log(`[ServiceTitan Sync] - Customers updated: ${s.customersUpdated}`),console.log(`[ServiceTitan Sync] - Job sync duration: ${(s.duration/1e3).toFixed(1)}s`);let r=(Date.now()-e)/1e3;console.log(`[ServiceTitan Sync] âœ¨ Full data sync completed in ${r.toFixed(1)}s`)}catch(e){console.error("[ServiceTitan Sync] âŒ Data sync failed:",e)}finally{c=!1}}async function l(){console.log("[ServiceTitan Sync] Scheduler started - will sync customers and jobs every 6 hours");try{let{customersXlsx:n,serviceTitanJobs:c}=await e.A(24067),{db:o}=await e.A(773428),{count:t}=await e.A(496359),s=await o.select({count:t()}).from(n),i=s[0]?.count||0,r=await o.select({count:t()}).from(c),l=r[0]?.count||0;console.log(`[ServiceTitan Sync] ðŸš€ Starting full data sync...`),console.log(`[ServiceTitan Sync] ðŸ“Š Current cache: ${i} customers, ${l} jobs`),a().catch(e=>{console.error("[ServiceTitan Sync] Initial sync failed:",e)})}catch(e){console.error("[ServiceTitan Sync] Failed to check data counts:",e)}setInterval(()=>{console.log("[ServiceTitan Sync] ðŸ”„ Starting scheduled 6-hour data sync..."),a().catch(e=>{console.error("[ServiceTitan Sync] Scheduled sync failed:",e)})},216e5)}e.s(["isSyncRunning",()=>t,"resetSyncLock",()=>s,"startServiceTitanSync",()=>l,"syncServiceTitanCustomers",()=>r,"syncServiceTitanData",()=>a,"updateSyncHeartbeat",()=>i])},24067,e=>{e.v(e=>Promise.resolve().then(()=>e(190337)))},773428,e=>{e.v(e=>Promise.resolve().then(()=>e(457420)))},496359,e=>{e.v(n=>Promise.all(["server/chunks/node_modules_drizzle-orm_index_d5f6a514.js"].map(n=>e.l(n))).then(()=>n(832628)))}];

//# sourceMappingURL=_e58db0c6._.js.map