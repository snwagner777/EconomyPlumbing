{"version":3,"sources":["turbopack:///[project]/server/lib/emailPreferenceEnforcer.ts"],"sourcesContent":["/**\n * Email Preference Enforcer\n * \n * Checks email preferences before sending and adds unsubscribe links/headers.\n * Ensures CAN-SPAM compliance for all outgoing emails.\n */\n\nimport { db } from '../db';\nimport { sql } from 'drizzle-orm';\nimport crypto from 'crypto';\n\ninterface EmailCategory {\n  type: 'marketing' | 'review' | 'referral' | 'service_reminder' | 'transactional';\n}\n\ninterface UnsubscribeInfo {\n  canSend: boolean;\n  reason?: string;\n  unsubscribeUrl?: string;\n  listUnsubscribeHeader?: string;\n  token?: string;\n}\n\n/**\n * Check if we can send an email to a recipient based on their preferences\n */\nexport async function canSendEmail(\n  email: string,\n  category: EmailCategory,\n  customerId?: number\n): Promise<UnsubscribeInfo> {\n  const { emailPreferences } = await import('@shared/schema');\n  \n  // Get or create preferences\n  const prefs = await getOrCreateEmailPreferences(email, customerId);\n  \n  // Transactional emails always go through\n  if (category.type === 'transactional') {\n    return {\n      canSend: true,\n      unsubscribeUrl: `${getBaseUrl()}/email-preferences/${prefs.unsubscribeToken}`,\n      listUnsubscribeHeader: `<${getBaseUrl()}/email-preferences/${prefs.unsubscribeToken}>`,\n      token: prefs.unsubscribeToken,\n    };\n  }\n  \n  // Check if they've opted out of everything\n  if (prefs.transactionalOnly) {\n    return {\n      canSend: false,\n      reason: 'Recipient has unsubscribed from all non-transactional emails',\n    };\n  }\n  \n  // Check specific category preferences\n  let canSend = true;\n  let reason = '';\n  \n  switch (category.type) {\n    case 'marketing':\n      canSend = prefs.marketingEmails;\n      reason = 'Recipient has opted out of marketing emails';\n      break;\n    case 'review':\n      canSend = prefs.reviewRequests;\n      reason = 'Recipient has opted out of review requests';\n      break;\n    case 'referral':\n      canSend = prefs.referralEmails;\n      reason = 'Recipient has opted out of referral emails';\n      break;\n    case 'service_reminder':\n      canSend = prefs.serviceReminders;\n      reason = 'Recipient has opted out of service reminders';\n      break;\n  }\n  \n  if (!canSend) {\n    return { canSend: false, reason };\n  }\n  \n  // Generate unsubscribe URLs and headers\n  const unsubscribeUrl = `${getBaseUrl()}/email-preferences/${prefs.unsubscribeToken}`;\n  const listUnsubscribeHeader = `<${unsubscribeUrl}>`;\n  \n  return {\n    canSend: true,\n    unsubscribeUrl,\n    listUnsubscribeHeader,\n    token: prefs.unsubscribeToken,\n  };\n}\n\n/**\n * Get or create email preferences for an email address\n */\nasync function getOrCreateEmailPreferences(email: string, customerId?: number): Promise<any> {\n  const { emailPreferences } = await import('@shared/schema');\n  \n  // Try to find existing preferences\n  const [existing] = await db\n    .select()\n    .from(emailPreferences)\n    .where(sql`${emailPreferences.email} = ${email.toLowerCase()}`)\n    .limit(1);\n  \n  if (existing) {\n    return existing;\n  }\n  \n  // Create new preferences with unique token\n  const token = crypto.randomBytes(32).toString('hex');\n  \n  const [created] = await db.insert(emailPreferences).values({\n    email: email.toLowerCase(),\n    customerId: customerId || null,\n    unsubscribeToken: token,\n    marketingEmails: true,\n    reviewRequests: true,\n    referralEmails: true,\n    serviceReminders: true,\n    transactionalOnly: false,\n  }).returning();\n  \n  return created;\n}\n\n/**\n * Add unsubscribe footer to HTML email\n */\nexport function addUnsubscribeFooter(htmlBody: string, unsubscribeUrl: string): string {\n  const footer = `\n    <div style=\"margin-top: 40px; padding-top: 20px; border-top: 1px solid #e5e7eb; font-size: 12px; color: #6b7280; text-align: center;\">\n      <p style=\"margin: 0 0 8px 0;\">\n        You're receiving this email because you're a valued customer of Economy Plumbing Services.\n      </p>\n      <p style=\"margin: 0;\">\n        <a href=\"${unsubscribeUrl}\" style=\"color: #3b82f6; text-decoration: underline;\">Manage your email preferences</a> or \n        <a href=\"${unsubscribeUrl}\" style=\"color: #3b82f6; text-decoration: underline;\">unsubscribe</a>\n      </p>\n      <p style=\"margin: 8px 0 0 0; font-size: 11px;\">\n        Economy Plumbing Services | Serving Austin & Central Texas<br/>\n        © ${new Date().getFullYear()} All rights reserved\n      </p>\n    </div>\n  `;\n  \n  // Insert footer before closing </body> tag or at the end\n  if (htmlBody.includes('</body>')) {\n    return htmlBody.replace('</body>', `${footer}</body>`);\n  }\n  \n  return htmlBody + footer;\n}\n\n/**\n * Add unsubscribe footer to plain text email\n */\nexport function addUnsubscribeFooterPlainText(plainText: string, unsubscribeUrl: string): string {\n  const footer = `\n\n---\nYou're receiving this email because you're a valued customer of Economy Plumbing Services.\n\nManage your email preferences: ${unsubscribeUrl}\nUnsubscribe: ${unsubscribeUrl}\n\nEconomy Plumbing Services | Serving Austin & Central Texas\n© ${new Date().getFullYear()} All rights reserved\n`;\n  \n  return plainText + footer;\n}\n\n/**\n * Get base URL for unsubscribe links\n */\nfunction getBaseUrl(): string {\n  // Production URL\n  if (process.env.NODE_ENV === 'production') {\n    return 'https://plumbersthatcare.com';\n  }\n  \n  // Development - use replit.dev domain if available\n  const replitDomain = process.env.REPLIT_DEV_DOMAIN;\n  if (replitDomain) {\n    return `https://${replitDomain}`;\n  }\n  \n  // Fallback to localhost\n  return 'http://localhost:5000';\n}\n"],"names":[],"mappings":"wCAOA,IAAA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QAiBO,eAAe,EACpB,CAAa,CACb,CAAuB,CACvB,CAAmB,EAEnB,GAAM,kBAAE,CAAgB,CAAE,CAAG,MAAA,EAAA,CAAA,CAAA,OAGvB,EAAQ,MAAM,EAA4B,EAAO,GAGvD,GAAsB,iBAAiB,CAAnC,EAAS,IAAI,CACf,MAAO,CACL,SAAS,EACT,eAAgB,CAAA,EAAG,IAAa,mBAAmB,EAAE,EAAM,gBAAgB,CAAA,CAAE,CAC7E,sBAAuB,CAAC,CAAC,EAAE,IAAa,mBAAmB,EAAE,EAAM,gBAAgB,CAAC,CAAC,CAAC,CACtF,MAAO,EAAM,gBAAgB,AAC/B,EAIF,GAAI,EAAM,iBAAiB,CACzB,CAD2B,KACpB,CACL,SAAS,EACT,OAAQ,8DACV,EAIF,IAAI,GAAU,EACV,EAAS,GAEb,OAAQ,EAAS,IAAI,EACnB,IAAK,YACH,EAAU,EAAM,eAAe,CAC/B,EAAS,8CACT,KACF,KAAK,SACH,EAAU,EAAM,cAAc,CAC9B,EAAS,6CACT,KACF,KAAK,WACH,EAAU,EAAM,cAAc,CAC9B,EAAS,6CACT,KACF,KAAK,mBACH,EAAU,EAAM,gBAAgB,CAChC,EAAS,8CAEb,CAEA,GAAI,CAAC,EACH,MAAO,CADK,AACH,SAAS,SAAO,CAAO,EAIlC,IAAM,EAAiB,CAAA,EAAG,IAAa,mBAAmB,EAAE,EAAM,gBAAgB,CAAA,CAAE,CAC9E,EAAwB,CAAC,CAAC,EAAE,EAAe,CAAC,CAAC,CAEnD,MAAO,CACL,SAAS,EACT,iBACA,wBACA,MAAO,EAAM,gBAAgB,AAC/B,CACF,CAKA,eAAe,EAA4B,CAAa,CAAE,CAAmB,EAC3E,GAAM,kBAAE,CAAgB,CAAE,CAAG,MAAA,EAAA,CAAA,CAAA,OAGvB,CAAC,EAAS,CAAG,MAAM,EAAA,EAAE,CACxB,MAAM,GACN,IAAI,CAAC,GACL,KAAK,CAAC,EAAA,GAAG,CAAC,EAAE,EAAiB,KAAK,CAAC,GAAG,EAAE,EAAM,WAAW,GAAG,CAAC,EAC7D,KAAK,CAAC,GAET,GAAI,EACF,OAAO,CADK,CAKd,IAAM,EAAQ,EAAA,OAAM,CAAC,WAAW,CAAC,IAAI,QAAQ,CAAC,OAExC,CAAC,EAAQ,CAAG,MAAM,EAAA,EAAE,CAAC,MAAM,CAAC,GAAkB,MAAM,CAAC,CACzD,MAAO,EAAM,WAAW,GACxB,WAAY,GAAc,KAC1B,iBAAkB,EAClB,iBAAiB,EACjB,gBAAgB,EAChB,gBAAgB,EAChB,iBAAkB,GAClB,mBAAmB,CACrB,GAAG,SAAS,GAEZ,OAAO,CACT,CAKO,SAAS,EAAqB,CAAgB,CAAE,CAAsB,EAC3E,IAAM,EAAS,CAAC;;;;;;iBAMD,EAAE,EAAe;iBACjB,EAAE,EAAe;;;;aAIxB,EAAE,IAAI,OAAO,WAAW,GAAG;;;EAGnC,CAAC,QAGD,AAAI,EAAS,QAAQ,CAAC,WACb,CADyB,CAChB,OAAO,CAAC,UAAW,CAAA,EAAG,EAAO,OAAO,CAAC,EAGhD,EAAW,CACpB,CAKO,SAAS,EAA8B,CAAiB,CAAE,CAAsB,EAarF,OAAO,EAZQ,CAAC,SAYG;;;;;+BAPU,EAAE,eAAe;aACnC,EAAE,eAAe;;;KAG5B,EAAE,IAAI,OAAO,WAAW,GAAG;AAC7B,CAAC,AAGD,CAKA,SAAS,IAGL,MAAO,8BAWX"}