module.exports=[81045,e=>{"use strict";var t=e.i(90337);e.i(54799);var s=e.i(57420),r=e.i(75225),a=e.i(18899),o=e.i(49129);let i=new class{async getUser(e){let[a]=await s.db.select().from(t.users).where((0,r.eq)(t.users.id,e));return a||void 0}async getUserByUsername(e){let[a]=await s.db.select().from(t.users).where((0,r.eq)(t.users.username,e));return a||void 0}async createUser(e){let[r]=await s.db.insert(t.users).values(e).returning();return r}async getBlogPosts(){return await s.db.select().from(t.blogPosts).orderBy((0,o.desc)(t.blogPosts.publishDate))}async getBlogPostBySlug(e){let[a]=await s.db.select().from(t.blogPosts).where((0,r.eq)(t.blogPosts.slug,e));return a||void 0}async createBlogPost(e){let[r]=await s.db.insert(t.blogPosts).values(e).returning();return r}async updateBlogPost(e,a){let[o]=await s.db.update(t.blogPosts).set(a).where((0,r.eq)(t.blogPosts.id,e)).returning();if(!o)throw Error(`Blog post with id ${e} not found`);return o}async getProducts(){return await s.db.select().from(t.products)}async getProductBySlug(e){let[a]=await s.db.select().from(t.products).where((0,r.eq)(t.products.slug,e));return a||void 0}async getProductById(e){let[a]=await s.db.select().from(t.products).where((0,r.eq)(t.products.id,e));return a||void 0}async createProduct(e){let[r]=await s.db.insert(t.products).values(e).returning();return r}async updateProduct(e,a){let[o]=await s.db.update(t.products).set(a).where((0,r.eq)(t.products.id,e)).returning();if(!o)throw Error(`Product with id ${e} not found`);return o}async createContactSubmission(e){let[r]=await s.db.insert(t.contactSubmissions).values(e).returning();return r}async createCustomerSuccessStory(e){let[r]=await s.db.insert(t.customerSuccessStories).values(e).returning();return r}async getApprovedSuccessStories(){return await s.db.select().from(t.customerSuccessStories).where((0,r.eq)(t.customerSuccessStories.approved,!0))}async getAllSuccessStories(){return await s.db.select().from(t.customerSuccessStories)}async approveSuccessStory(e,a,o){let[i]=await s.db.update(t.customerSuccessStories).set({approved:!0,collagePhotoUrl:a,jpegCollagePhotoUrl:o||null}).where((0,r.eq)(t.customerSuccessStories.id,e)).returning();if(!i)throw Error(`Success story with id ${e} not found`);return i}async unapproveSuccessStory(e){let[a]=await s.db.update(t.customerSuccessStories).set({approved:!1,collagePhotoUrl:null,jpegCollagePhotoUrl:null}).where((0,r.eq)(t.customerSuccessStories.id,e)).returning();if(!a)throw Error(`Success story with id ${e} not found`);return a}async updateSuccessStory(e,a){let[o]=await s.db.update(t.customerSuccessStories).set(a).where((0,r.eq)(t.customerSuccessStories.id,e)).returning();if(!o)throw Error(`Success story with id ${e} not found`);return o}async deleteSuccessStory(e){await s.db.delete(t.customerSuccessStories).where((0,r.eq)(t.customerSuccessStories.id,e))}async getServiceAreaBySlug(e){let[a]=await s.db.select().from(t.serviceAreas).where((0,r.eq)(t.serviceAreas.slug,e));return a||void 0}async getAllServiceAreas(){return await s.db.select().from(t.serviceAreas)}async createServiceArea(e){let[r]=await s.db.insert(t.serviceAreas).values(e).returning();return r}async getGoogleReviews(){return await s.db.select().from(t.googleReviews).orderBy(a.sql`${t.googleReviews.timestamp} DESC`)}async saveGoogleReviews(e){0!==e.length&&await s.db.insert(t.googleReviews).values(e)}async deleteGoogleReviews(e){0!==e.length&&await s.db.delete(t.googleReviews).where(a.sql`${t.googleReviews.id} = ANY(${e})`)}async clearGoogleReviews(){await s.db.delete(t.googleReviews)}async replaceGoogleReviews(e){0===e.length?console.warn("No reviews to save - skipping database update to preserve existing data"):await s.db.transaction(async s=>{await s.delete(t.googleReviews),await s.insert(t.googleReviews).values(e)})}async getGoogleOAuthToken(e="google_my_business"){let[a]=await s.db.select().from(t.googleOAuthTokens).where((0,r.eq)(t.googleOAuthTokens.service,e)).limit(1);return a||void 0}async saveGoogleOAuthToken(e){let[r]=await s.db.insert(t.googleOAuthTokens).values(e).returning();return r}async updateGoogleOAuthToken(e,a){let[o]=await s.db.update(t.googleOAuthTokens).set({...a,updatedAt:new Date}).where((0,r.eq)(t.googleOAuthTokens.id,e)).returning();return o}async getZoomOAuthToken(){let[e]=await s.db.select().from(t.zoomOAuthTokens).orderBy((0,o.desc)(t.zoomOAuthTokens.createdAt)).limit(1);return e}async saveZoomOAuthToken(e){let[r]=await s.db.insert(t.zoomOAuthTokens).values(e).returning();return r}async updateZoomOAuthToken(e,a){let[o]=await s.db.update(t.zoomOAuthTokens).set({...a,updatedAt:new Date}).where((0,r.eq)(t.zoomOAuthTokens.id,e)).returning();return o}async createServiceTitanMembership(e){let[r]=await s.db.insert(t.serviceTitanMemberships).values(e).returning();return r}async updateServiceTitanMembership(e,a){let[o]=await s.db.update(t.serviceTitanMemberships).set(a).where((0,r.eq)(t.serviceTitanMemberships.id,e)).returning();return o}async getServiceTitanMembershipById(e){let[a]=await s.db.select().from(t.serviceTitanMemberships).where((0,r.eq)(t.serviceTitanMemberships.id,e)).limit(1);return a||void 0}async getPendingServiceTitanMemberships(){return await s.db.select().from(t.serviceTitanMemberships).where(a.sql`${t.serviceTitanMemberships.syncStatus} IN ('pending', 'failed')`)}async createPendingPurchase(e){let[r]=await s.db.insert(t.pendingPurchases).values(e).returning();return r}async getPendingPurchaseByPaymentIntent(e){let[a]=await s.db.select().from(t.pendingPurchases).where((0,r.eq)(t.pendingPurchases.paymentIntentId,e)).limit(1);return a||void 0}async deletePendingPurchase(e){await s.db.delete(t.pendingPurchases).where((0,r.eq)(t.pendingPurchases.id,e))}async savePhotos(e){return 0===e.length?[]:await s.db.insert(t.companyCamPhotos).values(e).onConflictDoUpdate({target:t.companyCamPhotos.companyCamPhotoId,set:{qualityAnalyzed:a.sql`EXCLUDED.quality_analyzed`,isGoodQuality:a.sql`EXCLUDED.is_good_quality`,shouldKeep:a.sql`EXCLUDED.should_keep`,qualityScore:a.sql`EXCLUDED.quality_score`,qualityReasoning:a.sql`EXCLUDED.quality_reasoning`,analyzedAt:a.sql`EXCLUDED.analyzed_at`}}).returning()}async getAllPhotos(){let e=await s.db.select().from(t.companyCamPhotos).orderBy(a.sql`${t.companyCamPhotos.fetchedAt} DESC`),r=(await s.db.select().from(t.importedPhotos).orderBy(a.sql`${t.importedPhotos.fetchedAt} DESC`)).map(e=>({id:e.id,companyCamPhotoId:null,companyCamProjectId:null,photoUrl:e.url,thumbnailUrl:null,category:e.category,tags:e.aiTags||[],aiDescription:e.aiDescription,qualityAnalyzed:!0,isGoodQuality:e.isProductionQuality,shouldKeep:e.isProductionQuality,qualityScore:e.aiQuality||0,qualityReasoning:e.qualityReason||null,analyzedAt:e.fetchedAt,usedInBlogPostId:null,usedInPageUrl:null,blogTopicAnalyzed:!1,blogTopicAnalyzedAt:null,suggestedBlogTopic:null,fetchedAt:e.fetchedAt,photoSource:"google-drive"})),o=[...e.map(e=>({...e,photoSource:"companycam"})),...r];return o.sort((e,t)=>t.fetchedAt.getTime()-e.fetchedAt.getTime()),o}async getPhotosByCategory(e){return await s.db.select().from(t.companyCamPhotos).where(a.sql`${t.companyCamPhotos.category} = ${e} AND ${t.companyCamPhotos.shouldKeep} = true`)}async getPhotosByJob(e){return await s.db.select().from(t.companyCamPhotos).where(a.sql`${t.companyCamPhotos.companyCamProjectId} = ${e} AND ${t.companyCamPhotos.shouldKeep} = true`)}async getUnusedPhotos(e){return e?await s.db.select().from(t.companyCamPhotos).where(a.sql`${t.companyCamPhotos.category} = ${e} AND ${t.companyCamPhotos.usedInBlogPostId} IS NULL AND ${t.companyCamPhotos.usedInPageUrl} IS NULL AND ${t.companyCamPhotos.shouldKeep} = true`):await s.db.select().from(t.companyCamPhotos).where(a.sql`${t.companyCamPhotos.usedInBlogPostId} IS NULL AND ${t.companyCamPhotos.usedInPageUrl} IS NULL AND ${t.companyCamPhotos.shouldKeep} = true`)}async getPhotoById(e){let[a]=await s.db.select().from(t.companyCamPhotos).where((0,r.eq)(t.companyCamPhotos.id,e)).limit(1);if(a)return a;let[o]=await s.db.select().from(t.importedPhotos).where((0,r.eq)(t.importedPhotos.id,e)).limit(1);if(o)return{id:o.id,companyCamPhotoId:null,companyCamProjectId:null,photoUrl:o.url,url:o.url,thumbnailUrl:null,category:o.category,dateTaken:o.uploadDate||new Date,uploadDate:o.uploadDate||new Date,createdAt:o.createdAt,tags:[],aiDescription:o.aiDescription||null,aiQualityScore:o.aiQualityScore||0,isGoodQuality:!!o.aiQualityScore&&o.aiQualityScore>=70,shouldKeep:!0,usedInBlogPostId:o.usedInBlogPostId,usedInPageUrl:o.usedInPageUrl,blogTopic:null,source:"google-drive"}}async markPhotoAsUsed(e,a,o){let[i]=await s.db.update(t.companyCamPhotos).set({usedInBlogPostId:a||null,usedInPageUrl:o||null}).where((0,r.eq)(t.companyCamPhotos.id,e)).returning();if(i)return i;let[n]=await s.db.update(t.importedPhotos).set({usedInBlogPostId:a||null,usedInPageUrl:o||null}).where((0,r.eq)(t.importedPhotos.id,e)).returning();if(n)return{id:n.id,companyCamPhotoId:null,companyCamProjectId:null,photoUrl:n.url,url:n.url,thumbnailUrl:null,category:n.category,dateTaken:n.uploadDate||new Date,uploadDate:n.uploadDate||new Date,createdAt:n.createdAt,tags:[],aiDescription:n.aiDescription||null,aiQualityScore:n.aiQualityScore||0,isGoodQuality:!!n.aiQualityScore&&n.aiQualityScore>=70,shouldKeep:!0,usedInBlogPostId:n.usedInBlogPostId,usedInPageUrl:n.usedInPageUrl,blogTopic:null,source:"google-drive"};throw Error(`Photo with id ${e} not found`)}async getPhotosWithoutBlogTopic(){return await s.db.select().from(t.companyCamPhotos).where(a.sql`${t.companyCamPhotos.shouldKeep} = true 
        AND (${t.companyCamPhotos.usedInBlogPostId} IS NULL OR ${t.companyCamPhotos.usedInBlogPostId} = '') 
        AND (${t.companyCamPhotos.blogTopicAnalyzed} = false OR ${t.companyCamPhotos.blogTopicAnalyzed} IS NULL)`).orderBy(t.companyCamPhotos.qualityScore)}async updatePhotoWithBlogTopic(e,a){let[o]=await s.db.update(t.companyCamPhotos).set({suggestedBlogTopic:a,blogTopicAnalyzed:!0,blogTopicAnalyzedAt:new Date}).where((0,r.eq)(t.companyCamPhotos.id,e)).returning();return o}async saveBeforeAfterComposite(e){let[r]=await s.db.insert(t.beforeAfterComposites).values(e).returning();return r}async getBeforeAfterComposites(){return await s.db.select().from(t.beforeAfterComposites).orderBy(a.sql`${t.beforeAfterComposites.createdAt} DESC`)}async getUnusedComposites(){return await s.db.select().from(t.beforeAfterComposites).where(a.sql`${t.beforeAfterComposites.postedToFacebook} = false AND ${t.beforeAfterComposites.postedToInstagram} = false`).orderBy(a.sql`${t.beforeAfterComposites.createdAt} DESC`)}async markCompositeAsPosted(e,a,o){let[i]=await s.db.update(t.beforeAfterComposites).set({postedToFacebook:null!==a,postedToInstagram:null!==o,facebookPostId:a,instagramPostId:o,postedAt:new Date}).where((0,r.eq)(t.beforeAfterComposites.id,e)).returning();return i}async create404Error(e){let[r]=await s.db.insert(t.notFoundErrors).values(e).returning();return r}async get404Errors(e=100){return await s.db.select().from(t.notFoundErrors).orderBy(a.sql`${t.notFoundErrors.timestamp} DESC`).limit(e)}async createImportedPhoto(e){let[r]=await s.db.insert(t.importedPhotos).values(e).returning();return r}async getAllImportedPhotos(){return await s.db.select().from(t.importedPhotos).orderBy(a.sql`${t.importedPhotos.fetchedAt} DESC`)}async deleteImportedPhoto(e){await s.db.delete(t.importedPhotos).where((0,r.eq)(t.importedPhotos.id,e))}async deleteCompanyCamPhoto(e){await s.db.delete(t.companyCamPhotos).where((0,r.eq)(t.companyCamPhotos.id,e))}async getAllTrackingNumbers(){return await s.db.select().from(t.trackingNumbers).orderBy(a.sql`${t.trackingNumbers.sortOrder} ASC, ${t.trackingNumbers.channelName} ASC`)}async getActiveTrackingNumbers(){return await s.db.select().from(t.trackingNumbers).where((0,r.eq)(t.trackingNumbers.isActive,!0)).orderBy(a.sql`${t.trackingNumbers.sortOrder} ASC, ${t.trackingNumbers.channelName} ASC`)}async getTrackingNumberByKey(e){let[a]=await s.db.select().from(t.trackingNumbers).where((0,r.eq)(t.trackingNumbers.channelKey,e)).limit(1);return a}async getDefaultTrackingNumber(){let[e]=await s.db.select().from(t.trackingNumbers).where((0,r.eq)(t.trackingNumbers.isDefault,!0)).limit(1);return e}async createTrackingNumber(e){let[r]=await s.db.insert(t.trackingNumbers).values(e).returning();return r}async updateTrackingNumber(e,a){let[o]=await s.db.update(t.trackingNumbers).set({...a,updatedAt:new Date}).where((0,r.eq)(t.trackingNumbers.id,e)).returning();return o}async deleteTrackingNumber(e){await s.db.delete(t.trackingNumbers).where((0,r.eq)(t.trackingNumbers.id,e))}async getActiveCommercialCustomers(){return await s.db.select().from(t.commercialCustomers).where((0,r.eq)(t.commercialCustomers.active,!0)).orderBy(t.commercialCustomers.displayOrder)}async getAllCommercialCustomers(){return await s.db.select().from(t.commercialCustomers).orderBy(t.commercialCustomers.displayOrder)}async getCommercialCustomerById(e){let[a]=await s.db.select().from(t.commercialCustomers).where((0,r.eq)(t.commercialCustomers.id,e)).limit(1);return a}async createCommercialCustomer(e){let[r]=await s.db.insert(t.commercialCustomers).values(e).returning();return r}async updateCommercialCustomer(e,a){let[o]=await s.db.update(t.commercialCustomers).set(a).where((0,r.eq)(t.commercialCustomers.id,e)).returning();return o}async deleteCommercialCustomer(e){await s.db.delete(t.commercialCustomers).where((0,r.eq)(t.commercialCustomers.id,e))}async getAllPageMetadata(){return await s.db.select().from(t.pageMetadata).orderBy(t.pageMetadata.path)}async getPageMetadataByPath(e){let[a]=await s.db.select().from(t.pageMetadata).where((0,r.eq)(t.pageMetadata.path,e)).limit(1);return a}async upsertPageMetadata(e){let[r]=await s.db.insert(t.pageMetadata).values(e).onConflictDoUpdate({target:t.pageMetadata.path,set:{...e,updatedAt:new Date}}).returning();return r}async deletePageMetadata(e){await s.db.delete(t.pageMetadata).where((0,r.eq)(t.pageMetadata.id,e))}async getOAuthUser(e){let[a]=await s.db.select().from(t.oauthUsers).where((0,r.eq)(t.oauthUsers.id,e));return a}async upsertOAuthUser(e){let[r]=await s.db.insert(t.oauthUsers).values(e).onConflictDoUpdate({target:t.oauthUsers.id,set:{...e,updatedAt:new Date}}).returning();return r}async isEmailWhitelisted(e){let[a]=await s.db.select().from(t.adminWhitelist).where((0,r.eq)(t.adminWhitelist.email,e)).limit(1);return!!a}async addToWhitelist(e){let[r]=await s.db.insert(t.adminWhitelist).values(e).returning();return r}async removeFromWhitelist(e){await s.db.delete(t.adminWhitelist).where((0,r.eq)(t.adminWhitelist.email,e))}async getAllWhitelistedEmails(){return await s.db.select().from(t.adminWhitelist).orderBy(t.adminWhitelist.addedAt)}async createCustomReview(e){let[r]=await s.db.insert(t.customReviews).values(e).returning();return r}async getApprovedReviews(e){let r=a.sql`${t.customReviews.status} = 'approved' AND ${t.customReviews.displayOnWebsite} = true`;e?.featured&&(r=a.sql`${t.customReviews.status} = 'approved' AND ${t.customReviews.featured} = true AND ${t.customReviews.displayOnWebsite} = true`);let i=s.db.select().from(t.customReviews).where(r).orderBy((0,o.desc)(t.customReviews.submittedAt));return e?.limit?await i.limit(e.limit):await i}async getAllReviews(e){return e?await s.db.select().from(t.customReviews).where((0,r.eq)(t.customReviews.status,e)).orderBy((0,o.desc)(t.customReviews.submittedAt)):await s.db.select().from(t.customReviews).orderBy((0,o.desc)(t.customReviews.submittedAt))}async moderateReview(e,a){let o={status:a.status,moderatedBy:a.moderatedBy,moderatedAt:new Date};void 0!==a.moderationNotes&&(o.moderationNotes=a.moderationNotes),void 0!==a.featured&&(o.featured=a.featured),void 0!==a.displayOnWebsite&&(o.displayOnWebsite=a.displayOnWebsite);let[i]=await s.db.update(t.customReviews).set(o).where((0,r.eq)(t.customReviews.id,e)).returning();return i}async deleteReview(e){await s.db.delete(t.customReviews).where((0,r.eq)(t.customReviews.id,e))}async replyToReview(e,a){let[o]=await s.db.update(t.customReviews).set({replyText:a.trim(),repliedAt:new Date}).where((0,r.eq)(t.customReviews.id,e)).returning();return o}async getReviewStats(){let e=await s.db.select().from(t.customReviews);return{total:e.length,pending:e.filter(e=>"pending"===e.status).length,approved:e.filter(e=>"approved"===e.status).length,rejected:e.filter(e=>"rejected"===e.status).length,spam:e.filter(e=>"spam"===e.status).length,averageRating:e.length>0?e.reduce((e,t)=>e+t.rating,0)/e.length:0}}async getEnabledReviewPlatforms(){return await s.db.select().from(t.reviewPlatforms).where((0,r.eq)(t.reviewPlatforms.enabled,!0)).orderBy(t.reviewPlatforms.sortOrder)}async getAllReviewPlatforms(){return await s.db.select().from(t.reviewPlatforms).orderBy(t.reviewPlatforms.sortOrder)}async updateReviewPlatform(e,a){let[o]=await s.db.update(t.reviewPlatforms).set({...a,updatedAt:new Date}).where((0,r.eq)(t.reviewPlatforms.id,e)).returning();return o}async approveAIReviewResponse(e,t,a){await s.db.update(aiReviewResponses).set({status:"approved",approvedBy:t,approvedAt:new Date,editedResponse:a||void 0}).where((0,r.eq)(aiReviewResponses.id,e))}async acknowledgeNegativeReviewAlert(e,t){await s.db.update(negativeReviewAlerts).set({acknowledgedBy:t,acknowledgedAt:new Date}).where((0,r.eq)(negativeReviewAlerts.id,e))}async isEmailSuppressed(e){let[a]=await s.db.select().from(t.emailSuppressionList).where((0,r.eq)(t.emailSuppressionList.email,e));return!!a}async removeFromSuppressionList(e){await s.db.delete(t.emailSuppressionList).where((0,r.eq)(t.emailSuppressionList.email,e))}async getSuppressionStats(){let e=await s.db.select().from(t.emailSuppressionList);return{total:e.length,hardBounces:e.filter(e=>"hard_bounce"===e.reason).length,spamComplaints:e.filter(e=>"spam_complaint"===e.reason).length,manual:e.filter(e=>"manual_suppression"===e.reason).length}}async addToSuppressionList(e){await s.db.insert(t.emailSuppressionList).values({email:e.email,reason:e.reason,source:e.source,addedAt:new Date}).onConflictDoNothing()}async logEmailSend(e){await s.db.insert(t.emailSendLog).values({resendEmailId:e.emailId,recipientEmail:e.recipientEmail,campaignType:e.campaignType,campaignRecordId:"",emailNumber:1,customerId:0,sentAt:e.sentAt})}async getEmailLogByEmailId(e){let[a]=await s.db.select().from(t.emailSendLog).where((0,r.eq)(t.emailSendLog.resendEmailId,e));return a}async updateEmailLog(e,a){await s.db.update(t.emailSendLog).set(a).where((0,r.eq)(t.emailSendLog.resendEmailId,e))}async incrementCampaignEngagement(e,o,i){if("review_request"===o){let o="opened"===i?"emailsOpened":"emailsClicked";await s.db.update(t.reviewRequests).set({[o]:a.sql`${t.reviewRequests[o]} + 1`}).where((0,r.eq)(t.reviewRequests.id,e))}else if("referral_nurture"===o){let o="opened"===i?"emailsOpened":"emailsClicked";await s.db.update(t.referralNurtureCampaigns).set({[o]:a.sql`${t.referralNurtureCampaigns[o]} + 1`}).where((0,r.eq)(t.referralNurtureCampaigns.id,e))}}async getCustomerByServiceTitanId(e){let[a]=await s.db.select().from(t.customersXlsx).where((0,r.eq)(t.customersXlsx.id,e));return a}async createCustomerXlsx(e){let[r]=await s.db.insert(t.customersXlsx).values(e).returning();return r}async updateCustomerXlsx(e,a){let[o]=await s.db.update(t.customersXlsx).set(a).where((0,r.eq)(t.customersXlsx.id,e)).returning();return o}async getSegmentMembers(e,t){let a=s.db.select({id:segmentMembership.id,customerId:segmentMembership.serviceTitanCustomerId,customerName:segmentMembership.customerName,customerEmail:segmentMembership.customerEmail,customerPhone:segmentMembership.customerPhone,enteredAt:segmentMembership.enteredAt,exitedAt:segmentMembership.exitedAt,entryReason:segmentMembership.entryReason,exitReason:segmentMembership.exitReason,emailsSent:segmentMembership.emailsSent,emailsOpened:segmentMembership.emailsOpened,emailsClicked:segmentMembership.emailsClicked,callsMade:segmentMembership.callsMade,jobsBooked:segmentMembership.jobsBooked,revenueGenerated:segmentMembership.revenueGenerated}).from(segmentMembership).where((0,r.eq)(segmentMembership.segmentId,e));return t?.activeOnly&&(a=a.where((0,r.and)((0,r.eq)(segmentMembership.segmentId,e),(0,r.isNull)(segmentMembership.exitedAt)))),t?.limit&&(a=a.limit(t.limit)),t?.offset&&(a=a.offset(t.offset)),await a.orderBy((0,o.desc)(segmentMembership.enteredAt))}async getCustomerSegmentMemberships(e,t){let a=s.db.select({membershipId:segmentMembership.id,segmentId:segmentMembership.segmentId,segmentName:customerSegments.name,segmentDescription:customerSegments.description,enteredAt:segmentMembership.enteredAt,exitedAt:segmentMembership.exitedAt,entryReason:segmentMembership.entryReason,exitReason:segmentMembership.exitReason}).from(segmentMembership).leftJoin(customerSegments,(0,r.eq)(segmentMembership.segmentId,customerSegments.id)).where((0,r.eq)(segmentMembership.serviceTitanCustomerId,e));return t?.activeOnly&&(a=a.where((0,r.and)((0,r.eq)(segmentMembership.serviceTitanCustomerId,e),(0,r.isNull)(segmentMembership.exitedAt)))),await a.orderBy((0,o.desc)(segmentMembership.enteredAt))}async getSegmentMemberCount(e,t=!0){let o=s.db.select({count:a.sql`count(*)`}).from(segmentMembership).where((0,r.eq)(segmentMembership.segmentId,e));t&&(o=o.where((0,r.and)((0,r.eq)(segmentMembership.segmentId,e),(0,r.isNull)(segmentMembership.exitedAt))));let i=await o;return Number(i[0]?.count||0)}async getAudienceMovementLogs(e){let t=s.db.select().from(audienceMovementLogs),i=[];return e?.segmentId&&i.push((0,r.eq)(audienceMovementLogs.segmentId,e.segmentId)),e?.customerId&&i.push((0,r.eq)(audienceMovementLogs.serviceTitanCustomerId,e.customerId)),e?.action&&i.push((0,r.eq)(audienceMovementLogs.action,e.action)),i.length>0&&(t=t.where(a.sql`${a.sql.join(i,a.sql` AND `)}`)),e?.limit&&(t=t.limit(e.limit)),e?.offset&&(t=t.offset(e.offset)),await t.orderBy((0,o.desc)(audienceMovementLogs.occurredAt))}};e.s(["storage",0,i])}];

//# sourceMappingURL=server_storage_ts_8fd51d09._.js.map