---
import '../styles/global.css';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';

export interface Props {
  title: string;
  description: string;
  image?: string;
  canonical?: string;
  noindex?: boolean;
}

const { 
  title, 
  description, 
  image = '/hero_image.png',
  canonical,
  noindex = false,
} = Astro.props;

const siteUrl = 'https://plumbersthatcare.com';
const fullUrl = canonical || `${siteUrl}${Astro.url.pathname}`;
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <!-- SEO Meta Tags -->
    <title>{title}</title>
    <meta name="description" content={description} />
    {canonical && <link rel="canonical" href={canonical} />}
    {noindex && <meta name="robots" content="noindex, nofollow" />}
    
    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={fullUrl} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={`${siteUrl}${image}`} />
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={`${siteUrl}${image}`} />
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    
    <!-- Fonts - Inter and Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link 
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700;800&display=swap" 
      rel="stylesheet" 
    />
    <!-- ServiceTitan Scheduler Script -->
    <script is:inline>
      (function(q,w,e,r,t,y,u){q[t]=q[t]||function(){(q[t].q = q[t].q || []).push(arguments)};
        q[t].l=1*new Date();y=w.createElement(e);u=w.getElementsByTagName(e)[0];y.async=true;
        y.src=r;u.parentNode.insertBefore(y,u);q[t]('init', '3ce4a586-8427-4716-9ac6-46cb8bf7ac4f');
      })(window, document, 'script', 'https://static.servicetitan.com/webscheduler/shim.js', 'STWidgetManager');
    </script>
  </head>
  <body>
    <div id="app" class="min-h-screen bg-background text-foreground flex flex-col">
      <Header />
      <main class="flex-1">
        <slot />
      </main>
      <Footer />
    </div>
    
    <!-- Phone Detection Script -->
    <script is:inline>
      (function() {
        var DEFAULT_PHONE = { display: '(512) 368-9159', tel: 'tel:+15123689159' };
        var MARBLE_FALLS_PHONE = { display: '(830) 460-3565', tel: 'tel:+18304603565' };
        var COOKIE_NAME = 'traffic_source';
        var COOKIE_DAYS = 90;

        function getCookie(name) {
          var value = '; ' + document.cookie;
          var parts = value.split('; ' + name + '=');
          if (parts.length === 2) return parts.pop().split(';').shift();
          return null;
        }

        function setCookie(name, value, days) {
          var date = new Date();
          date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
          var expires = 'expires=' + date.toUTCString();
          document.cookie = name + '=' + value + ';' + expires + ';path=/';
        }

        function detectTrafficSource(trackingNumbers) {
          var urlParams = new URLSearchParams(window.location.search);
          var referrer = document.referrer.toLowerCase();
          var utmSource = urlParams.get('utm_source');
          if (utmSource) utmSource = utmSource.toLowerCase();

          for (var i = 0; i < trackingNumbers.length; i++) {
            var number = trackingNumbers[i];
            if (number.isDefault) continue;

            try {
              var rules = JSON.parse(number.detectionRules);

              if (rules.urlParams) {
                for (var j = 0; j < rules.urlParams.length; j++) {
                  if (urlParams.has(rules.urlParams[j])) {
                    return number;
                  }
                }
              }

              if (rules.utmSources && utmSource) {
                for (var k = 0; k < rules.utmSources.length; k++) {
                  if (rules.utmSources[k].toLowerCase() === utmSource) {
                    return number;
                  }
                }
              }

              if (rules.referrerIncludes && referrer) {
                for (var m = 0; m < rules.referrerIncludes.length; m++) {
                  if (referrer.indexOf(rules.referrerIncludes[m].toLowerCase()) !== -1) {
                    return number;
                  }
                }
              }
            } catch (error) {
              console.error('[PhoneConfig] Error parsing detection rules:', error);
            }
          }

          return null;
        }

        function getPhoneNumberFromTracking(trackingNumbers) {
          var detected = detectTrafficSource(trackingNumbers);
          
          if (detected) {
            setCookie(COOKIE_NAME, detected.channelKey, COOKIE_DAYS);
            return {
              display: detected.displayNumber,
              tel: detected.telLink
            };
          }

          var sourceCookie = getCookie(COOKIE_NAME);
          if (sourceCookie) {
            for (var i = 0; i < trackingNumbers.length; i++) {
              if (trackingNumbers[i].channelKey === sourceCookie) {
                return {
                  display: trackingNumbers[i].displayNumber,
                  tel: trackingNumbers[i].telLink
                };
              }
            }
          }

          for (var j = 0; j < trackingNumbers.length; j++) {
            if (trackingNumbers[j].isDefault) {
              return {
                display: trackingNumbers[j].displayNumber,
                tel: trackingNumbers[j].telLink
              };
            }
          }

          return DEFAULT_PHONE;
        }

        function updatePhoneElements(phoneConfig) {
          var elements = document.querySelectorAll('[data-phone="austin"]');
          for (var i = 0; i < elements.length; i++) {
            var el = elements[i];
            if (el.tagName === 'A') {
              el.href = phoneConfig.tel;
              el.textContent = phoneConfig.display;
            }
          }
        }

        function initializePhoneNumbers() {
          fetch('/api/tracking-numbers')
            .then(function(response) {
              if (!response.ok) throw new Error('Failed to fetch tracking numbers');
              return response.json();
            })
            .then(function(data) {
              var trackingNumbers = data.trackingNumbers || [];
              
              if (trackingNumbers.length === 0) {
                console.warn('[PhoneDetection] No tracking numbers configured, using defaults');
                window.__PHONE_CONFIG__ = DEFAULT_PHONE;
                window.__MARBLE_FALLS_PHONE_CONFIG__ = MARBLE_FALLS_PHONE;
                return;
              }

              var phoneConfig = getPhoneNumberFromTracking(trackingNumbers);
              window.__PHONE_CONFIG__ = phoneConfig;
              window.__MARBLE_FALLS_PHONE_CONFIG__ = MARBLE_FALLS_PHONE;
              updatePhoneElements(phoneConfig);
            })
            .catch(function(error) {
              console.error('[PhoneDetection] Error initializing phone numbers:', error);
              window.__PHONE_CONFIG__ = DEFAULT_PHONE;
              window.__MARBLE_FALLS_PHONE_CONFIG__ = MARBLE_FALLS_PHONE;
            });
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initializePhoneNumbers);
        } else {
          initializePhoneNumbers();
        }
      })();
    </script>
    
    <!-- Global Scheduler Function -->
    <script is:inline>
      // Global function to open ServiceTitan scheduler
      window.openScheduler = function() {
        console.log('Opening ServiceTitan scheduler...');
        if (typeof window.STWidgetManager === 'function') {
          try {
            window.STWidgetManager('ws-open');
            console.log('Scheduler opened successfully');
            return true;
          } catch (error) {
            console.error('Error opening scheduler:', error);
            showSchedulerError();
            return false;
          }
        } else {
          console.error('ServiceTitan scheduler not loaded yet');
          showSchedulerError();
          return false;
        }
      };
      
      function showSchedulerError() {
        var austinPhone = window.__PHONE_CONFIG__?.display || '(512) 368-9159';
        var marbleFallsPhone = window.__MARBLE_FALLS_PHONE_CONFIG__?.display || '(830) 460-3565';
        
        alert(
          'Online scheduler is temporarily unavailable.\n\n' +
          'Please call us directly:\n' +
          'Austin: ' + austinPhone + '\n' +
          'Marble Falls: ' + marbleFallsPhone + '\n\n' +
          'Or refresh the page and try again.'
        );
      }
    </script>
    
    <!-- Analytics scripts will be added here -->
  </body>
</html>
